<!DOCTYPE html>
<html lang="es-ES">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zhentio Chk</title>
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%2306b6d4'/></svg>" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
  <style>
    body {
      background: linear-gradient(135deg, #1e293b 0%, #0f766e 50%, #2dd4bf 100%);
      color: #fff;
      padding: 1rem;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container.text-white.rounded.shadow.p-3.my-4 {
      background: rgba(8, 145, 178, 0.2);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 2px solid rgba(6, 182, 212, 0.3);
      box-shadow: 0 12px 40px rgba(6, 182, 212, 0.2);
    }
    button {
      padding: 14px 28px;
      background: linear-gradient(45deg, #0891b2, #06b6d4);
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 25px;
      margin-right: 8px;
      margin-bottom: 5px;
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
      transition: all 0.3s ease;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 16px;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.6);
      background: linear-gradient(45deg, #06b6d4, #0891b2);
    }
    button:disabled {
      background: linear-gradient(45deg, #475569, #64748b);
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 2px 8px rgba(100, 116, 139, 0.3);
    }
    #chk-start {
      background: linear-gradient(45deg, #0ea5e9, #0284c7);
      box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
    }
    #chk-start:hover {
      background: linear-gradient(45deg, #0284c7, #0ea5e9);
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.6);
    }
    #chk-pause {
      background: linear-gradient(45deg, #06b6d4, #0891b2);
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }
    #chk-pause:hover {
      background: linear-gradient(45deg, #0891b2, #06b6d4);
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.6);
    }
    #chk-stop {
      background: linear-gradient(45deg, #0c4a6e, #075985);
      box-shadow: 0 6px 20px rgba(12, 74, 110, 0.4);
    }
    #chk-stop:hover {
      background: linear-gradient(45deg, #075985, #0c4a6e);
      box-shadow: 0 8px 25px rgba(12, 74, 110, 0.6);
    }
    #chk-clean {
      background: linear-gradient(45deg, #0369a1, #0284c7);
      box-shadow: 0 6px 20px rgba(3, 105, 161, 0.4);
    }
    #chk-clean:hover {
      background: linear-gradient(45deg, #0284c7, #0369a1);
      box-shadow: 0 8px 25px rgba(3, 105, 161, 0.6);
    }
    .nav-tabs {
      background: rgba(6, 182, 212, 0.2);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      padding: 10px;
      margin-bottom: 0;
      box-shadow: 0 6px 25px rgba(6, 182, 212, 0.2);
    }
    .nav-tabs .nav-item a.nav-link {
      background: rgba(14, 165, 233, 0.2) !important;
      border: 2px solid rgba(6, 182, 212, 0.3);
      color: #67e8f9;
      margin-right: 10px;
      border-radius: 15px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      padding: 0;
      font-size: 24px;
      backdrop-filter: blur(10px);
    }
    .nav-tabs .nav-item a.nav-link:hover {
      border-color: rgba(6, 182, 212, 0.6);
      color: #a5f3fc;
      background: rgba(6, 182, 212, 0.3) !important;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.3);
    }
    .nav-tabs .nav-item a.nav-link.active {
      border: 2px solid #06b6d4;
      color: white !important;
      background: linear-gradient(45deg, #0891b2, #06b6d4) !important;
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.5);
    }
    .tab-content {
      background: rgba(6, 182, 212, 0.15);
      backdrop-filter: blur(15px);
      color: #fff;
      padding: 25px 30px;
      border-radius: 20px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      min-height: 280px;
      box-shadow: 0 10px 35px rgba(6, 182, 212, 0.2);
    }
    textarea {
      background: rgba(6, 182, 212, 0.15);
      backdrop-filter: blur(15px);
      color: #a5f3fc;
      width: 100%;
      border-radius: 15px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      padding: 20px;
      resize: none;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    textarea:focus {
      outline: none;
      box-shadow: 0 0 25px rgba(6, 182, 212, 0.5);
      border: 2px solid #06b6d4;
      background: rgba(6, 182, 212, 0.25);
      color: #ffffff;
    }
    textarea::placeholder {
      color: rgba(165, 243, 252, 0.7);
    }
    .badge-warning {
      background: linear-gradient(45deg, #0891b2, #06b6d4);
      color: white;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 14px;
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }
    #lives, #dies, #errors {
      max-height: 300px;
      overflow-y: auto;
      padding: 20px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      border-radius: 15px;
      background: rgba(12, 74, 110, 0.4);
      backdrop-filter: blur(15px);
      color: #a5f3fc;
      margin-top: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: 'Courier New', monospace;
      font-size: 15px;
      box-shadow: inset 0 3px 15px rgba(6, 182, 212, 0.2);
    }
    #lives {
      border-left: 4px solid #06b6d4;
    }
    #dies {
      border-left: 4px solid #0369a1;
    }
    #errors {
      border-left: 4px solid #0891b2;
    }
    .val-lives, .val-dies, .val-errors, .val-tested, .val-total {
      color: #67e8f9;
      font-weight: bold;
      text-shadow: 0 2px 5px rgba(6, 182, 212, 0.5);
    }
    .val-dies {
      color: #0ea5e9 !important;
    }
    .val-errors {
      color: #0891b2 !important;
    }
    .val-tested {
      color: #06b6d4 !important;
    }
    .val-total {
      color: #a5f3fc !important;
    }
    h3 {
      text-shadow: 0 3px 15px rgba(6, 182, 212, 0.5);
      font-weight: bold;
      color: #a5f3fc;
    }
    h5 {
      color: #67e8f9;
      text-shadow: 0 2px 8px rgba(6, 182, 212, 0.4);
      margin-bottom: 18px;
      font-size: 20px;
    }
    label {
      color: #a5f3fc;
      font-weight: 600;
      margin-bottom: 10px;
      text-shadow: 0 2px 5px rgba(6, 182, 212, 0.4);
      font-size: 17px;
    }
    #copyButton {
      background: linear-gradient(45deg, #0ea5e9, #0284c7);
      padding: 12px 18px;
      border-radius: 12px;
      margin-right: 8px;
      font-size: 15px;
    }
    #copyButton:hover {
      background: linear-gradient(45deg, #0284c7, #0ea5e9);
    }
    .container .my-2 {
      background: rgba(6, 182, 212, 0.1);
      padding: 18px;
      border-radius: 15px;
      margin: 18px 0;
      border: 2px solid rgba(14, 165, 233, 0.2);
      backdrop-filter: blur(10px);
    }
    .container .my-2 span {
      font-size: 18px;
    }
    /* Scrollbar personalizado con tema azul */
    #lives::-webkit-scrollbar, #dies::-webkit-scrollbar, #errors::-webkit-scrollbar {
      width: 8px;
    }
    #lives::-webkit-scrollbar-track, #dies::-webkit-scrollbar-track, #errors::-webkit-scrollbar-track {
      background: rgba(6, 182, 212, 0.2);
      border-radius: 4px;
    }
    #lives::-webkit-scrollbar-thumb {
      background: #06b6d4;
      border-radius: 4px;
    }
    #dies::-webkit-scrollbar-thumb {
      background: #0ea5e9;
      border-radius: 4px;
    }
    #errors::-webkit-scrollbar-thumb {
      background: #0891b2;
      border-radius: 4px;
    }
    /* Animación de pulso mejorada con colores azules */
    @keyframes pulse {
      0% { 
        transform: scale(1); 
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
      }
      50% { 
        transform: scale(1.05); 
        box-shadow: 0 8px 25px rgba(6, 182, 212, 0.6);
      }
      100% { 
        transform: scale(1); 
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
      }
    }
    .badge-warning {
      animation: pulse 2s infinite;
    }
    /* Header styles */
    .header-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    .header-logo {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 3px solid rgba(6, 182, 212, 0.4);
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.3);
      transition: all 0.3s ease;
      object-fit: cover;
    }
    .header-logo:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(6, 182, 212, 0.5);
      border-color: rgba(6, 182, 212, 0.6);
    }
    /* Animación flotante para el logo */
    @keyframes logoFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-3px); }
    }
    .header-logo {
      animation: logoFloat 3s ease-in-out infinite;
    }
    .header-title {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .main-title {
      font-size: 32px;
      font-weight: bold;
      color: #a5f3fc;
      text-shadow: 0 3px 15px rgba(6, 182, 212, 0.5);
      margin: 0;
      line-height: 1;
    }

    /* Estilos para la pantalla de login */
    #loginScreen {
      min-height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #loginScreen.show {
      display: flex !important;
    }

    .login-container {
      background: rgba(8, 145, 178, 0.2);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      border: 2px solid rgba(6, 182, 212, 0.3);
      box-shadow: 0 12px 40px rgba(6, 182, 212, 0.2);
      padding: 40px;
      max-width: 450px;
      width: 100%;
      text-align: center;
    }

    .login-title {
      font-size: 28px;
      font-weight: bold;
      color: #a5f3fc;
      text-shadow: 0 3px 15px rgba(6, 182, 212, 0.5);
      margin-bottom: 30px;
    }

    .login-subtitle {
      color: #67e8f9;
      margin-bottom: 25px;
      font-size: 16px;
    }

    #keyInput {
      background: rgba(6, 182, 212, 0.15);
      backdrop-filter: blur(15px);
      color: #a5f3fc;
      width: 100%;
      border-radius: 15px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      padding: 15px 20px;
      font-size: 16px;
      margin-bottom: 20px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
    }

    #keyInput:focus {
      outline: none;
      box-shadow: 0 0 25px rgba(6, 182, 212, 0.5);
      border: 2px solid #06b6d4;
      background: rgba(6, 182, 212, 0.25);
      color: #ffffff;
    }

    #keyInput::placeholder {
      color: rgba(165, 243, 252, 0.7);
      text-transform: none;
      letter-spacing: normal;
    }

    #loginBtn {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
    }

    /* Información de sesión */
    #sessionInfo {
      background: rgba(6, 182, 212, 0.15);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      padding: 12px 20px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      color: #67e8f9;
      font-size: 14px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #logoutBtn {
      background: linear-gradient(45deg, #0c4a6e, #075985);
      padding: 8px 16px;
      font-size: 12px;
      border-radius: 20px;
      margin-left: 10px;
    }

    #logoutBtn:hover {
      background: linear-gradient(45deg, #075985, #0c4a6e);
    }

    #mainApp {
      display: none;
    }

    /* Estilos para el Panel de Administración */
    #adminPanel {
      display: none;
      padding: 20px 0;
    }

    .admin-container {
      background: rgba(8, 145, 178, 0.15);
      backdrop-filter: blur(20px);
      border-radius: 25px;
      border: 2px solid rgba(6, 182, 212, 0.4);
      box-shadow: 0 15px 50px rgba(6, 182, 212, 0.3);
      padding: 35px;
      margin-bottom: 25px;
      transition: all 0.3s ease;
    }

    .admin-container:hover {
      box-shadow: 0 20px 60px rgba(6, 182, 212, 0.4);
      transform: translateY(-2px);
    }

    .admin-header {
      text-align: center;
      margin-bottom: 35px;
      position: relative;
    }

    .admin-header::after {
      content: '';
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: linear-gradient(45deg, #06b6d4, #0ea5e9);
      border-radius: 2px;
    }

    .admin-title {
      font-size: 32px;
      font-weight: bold;
      color: #a5f3fc;
      text-shadow: 0 4px 20px rgba(6, 182, 212, 0.6);
      margin-bottom: 12px;
      letter-spacing: 1px;
    }

    .admin-subtitle {
      color: #67e8f9;
      font-size: 18px;
      font-weight: 500;
    }

    .key-management {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.08), rgba(14, 165, 233, 0.12));
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 25px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      backdrop-filter: blur(15px);
      position: relative;
      overflow: hidden;
    }

    .key-management::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #06b6d4, #0ea5e9, #0284c7);
    }

    .key-management h4 {
      color: #a5f3fc;
      margin-bottom: 25px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #a5f3fc;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input, .form-group select {
      background: rgba(6, 182, 212, 0.12);
      backdrop-filter: blur(10px);
      color: #ffffff;
      width: 100%;
      border-radius: 12px;
      border: 2px solid rgba(14, 165, 233, 0.3);
      padding: 14px 18px;
      font-size: 15px;
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 10px rgba(6, 182, 212, 0.1);
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      box-shadow: 0 0 25px rgba(6, 182, 212, 0.4), inset 0 2px 10px rgba(6, 182, 212, 0.2);
      border: 2px solid #06b6d4;
      background: rgba(6, 182, 212, 0.2);
      transform: translateY(-1px);
    }

    .form-group input::placeholder {
      color: rgba(165, 243, 252, 0.6);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .btn-admin {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-right: 12px;
      margin-bottom: 12px;
      border-radius: 25px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }

    .btn-admin::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-admin:hover::before {
      left: 100%;
    }

    .btn-admin:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .btn-primary {
      background: linear-gradient(45deg, #0ea5e9, #0284c7);
      color: white;
    }

    .btn-success {
      background: linear-gradient(45deg, #10b981, #059669);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(45deg, #ef4444, #dc2626);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(45deg, #f59e0b, #d97706);
      color: white;
    }

    .keys-table {
      background: linear-gradient(135deg, rgba(12, 74, 110, 0.3), rgba(8, 145, 178, 0.2));
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 25px;
      margin-top: 25px;
      border: 2px solid rgba(14, 165, 233, 0.4);
      max-height: 500px;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(6, 182, 212, 0.2);
    }

    .keys-table h4 {
      color: #a5f3fc;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .keys-table table {
      width: 100%;
      color: #a5f3fc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 13px;
      border-collapse: collapse;
    }

    .keys-table th {
      background: linear-gradient(45deg, rgba(6, 182, 212, 0.4), rgba(14, 165, 233, 0.3));
      color: #ffffff;
      padding: 15px 10px;
      text-align: left;
      font-weight: bold;
      border-bottom: 2px solid rgba(6, 182, 212, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .keys-table td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(6, 182, 212, 0.2);
      vertical-align: middle;
    }

    .keys-table tr:hover {
      background: rgba(6, 182, 212, 0.15);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    .key-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-block;
      min-width: 70px;
      text-align: center;
    }

    .status-active {
      background: linear-gradient(45deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.4));
      color: #10b981;
      border: 2px solid #10b981;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .status-inactive {
      background: linear-gradient(45deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.4));
      color: #ef4444;
      border: 2px solid #ef4444;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }

    .status-expired {
      background: linear-gradient(45deg, rgba(245, 158, 11, 0.3), rgba(217, 119, 6, 0.4));
      color: #f59e0b;
      border: 2px solid #f59e0b;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 11px;
      margin: 2px;
      border-radius: 15px;
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.12), rgba(14, 165, 233, 0.08));
      border-radius: 20px;
      padding: 25px;
      text-align: center;
      border: 2px solid rgba(14, 165, 233, 0.3);
      backdrop-filter: blur(15px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #06b6d4, #0ea5e9);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(6, 182, 212, 0.3);
      border-color: rgba(6, 182, 212, 0.5);
    }

    .stat-number {
      font-size: 42px;
      font-weight: bold;
      color: #06b6d4;
      text-shadow: 0 4px 15px rgba(6, 182, 212, 0.6);
      margin-bottom: 8px;
      line-height: 1;
    }

    .stat-label {
      color: #67e8f9;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Animaciones mejoradas */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .stat-card:hover .stat-number {
      animation: pulse 0.6s ease-in-out;
    }

    #adminPanel.show {
      animation: slideInUp 0.5s ease-out;
    }

    /* Scrollbar personalizado para la tabla */
    .keys-table::-webkit-scrollbar {
      width: 8px;
    }

    .keys-table::-webkit-scrollbar-track {
      background: rgba(6, 182, 212, 0.1);
      border-radius: 4px;
    }

    .keys-table::-webkit-scrollbar-thumb {
      background: linear-gradient(45deg, #06b6d4, #0ea5e9);
      border-radius: 4px;
    }

    .keys-table::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(45deg, #0ea5e9, #0284c7);
    }

    /* Responsive para móviles */
    @media (max-width: 768px) {
      .admin-container {
        padding: 20px;
        margin: 10px;
      }
      
      .admin-title {
        font-size: 24px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .admin-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .keys-table {
        padding: 15px;
        font-size: 11px;
      }
      
      .keys-table th, .keys-table td {
        padding: 8px 5px;
      }
    }
  </style>
</head>
<body>
  <div id="loginScreen">
    <div class="login-container">
      <div class="header-container">
        <img src="logo.png" alt="Logo" class="header-logo">
        <div class="header-title">
          <h3 class="login-title">CHECKER ALL BINS</h3>
        </div>
      </div>
      
      <p class="login-subtitle">Ingresa tu key de acceso para continuar</p>
      
      <input type="text" id="keyInput" placeholder="Ingresa tu KEY aquí..." maxlength="40">
      <button id="loginBtn"><i class="fas fa-key"></i> Acceder</button>
      
      <div style="margin-top: 25px; padding: 10px; background: rgba(6, 182, 212, 0.1); border-radius: 8px; font-size: 12px; color: #67e8f9; text-align: center;">
        <i class="fas fa-shield-alt"></i> Sistema protegido con validación de servidor y detección anti-manipulación
      </div>
    </div>
  </div>

  <div id="mainApp">
    <div id="sessionInfo">
      <span>Cargando información de sesión...</span>
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
    </div>

  <div class="container text-white rounded shadow p-3 my-4">
    <div class="container-fluid">
      <div class="header-container">
        <img src="logo.png" alt="Logo" class="header-logo">
        <div class="header-title">
          <h3 class="main-title">CHECKER ALL BINS</h3>
        </div>
      </div>
    </div>
    <div class="container-fluid mt-3">
      <div class="buttons">
        <button id="chk-start"><i class="fas fa-play"></i> Iniciar</button>
        <button id="chk-pause" disabled><i class="fas fa-pause"></i> Pausar</button>
        <button id="chk-stop" disabled><i class="fas fa-stop"></i> Parar</button>
        <button id="chk-clean"><i class="fas fa-trash-alt"></i> Limpiar</button>
      </div>
    </div>
    <div class="container-fluid mt-3">
      <span class="badge badge-warning" id="estatus">Esperando inicio...</span>
    </div>
  </div>

  <div class="container p-0 shadow">
    <ul class="nav nav-tabs" id="myTab" role="tablist" style="border: none;">
      <li class="nav-item">
        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#chk-home" role="tab" aria-controls="home" aria-selected="true" title="Tarjetas">
          <i class="far fa-credit-card"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#chk-lives" role="tab" aria-controls="profile" aria-selected="false" title="Aprobadas">
          <i class="fa fa-thumbs-up fa-lg"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="contact-tab" data-toggle="tab" href="#chk-dies" role="tab" aria-controls="contact" aria-selected="false" title="Reprobadas">
          <i class="fa fa-thumbs-down fa-lg"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="errors-tab" data-toggle="tab" href="#chk-errors" role="tab" aria-controls="errors" aria-selected="false" title="Errores">
          <i class="fas fa-times fa-lg"></i>
        </a>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active px-3 pt-4 pb-3" id="chk-home" role="tabpanel" aria-labelledby="home-tab">
        <div class="my-2">
          Aprobadas: <span class="val-lives" style="font-weight: bold;">0</span>
          Reprobadas: <span class="val-dies" style="font-weight: bold;">0</span>
          Errores: <span class="val-errors" style="font-weight: bold;">0</span>
          Testeadas: <span class="val-tested" style="font-weight: bold;">0</span>
          Total: <span class="val-total" style="font-weight: bold;">0</span>
        </div>

        <div class="container-fluid p-0 mt-2">
          <label for="cookie_input"><i class="fas fa-cookie-bite"></i> Cookies</label>
          <textarea id="cookie_input" placeholder="Pega aquí tus cookies de Amazon..." rows="2"></textarea>
        </div>

        <div class="container-fluid p-0 mt-2">
          <label for="lista_cartoes"><i class="far fa-credit-card"></i> Lista de tarjetas:</label>
          <textarea id="lista_cartoes" placeholder="Ingrese su lista..." rows="8"></textarea>
        </div>
      </div>

      <div class="tab-pane fade px-3 pt-4 pb-3" id="chk-lives" role="tabpanel" aria-labelledby="profile-tab">
        <h5>Aprobadas</h5>
        <span>Total: <span class="val-lives">0</span></span>
        <br />
        <button id="copyButton"><i class="fas fa-copy"></i> Copiar</button>
        <button onclick="document.getElementById('lives').innerHTML = ''; updateCountsDisplay();"><i class="fas fa-trash-alt"></i> Limpiar</button>
        <pre id="lives"></pre>
      </div>

      <div class="tab-pane fade px-3 pt-4 pb-3" id="chk-dies" role="tabpanel" aria-labelledby="contact-tab">
        <h5>Reprobadas</h5>
        <span>Total: <span class="val-dies">0</span></span>
        <br />
        <button onclick="document.getElementById('dies').innerHTML = ''; updateCountsDisplay();"><i class="fas fa-trash-alt"></i> Limpiar</button>
        <pre id="dies"></pre>
      </div>

      <div class="tab-pane fade px-3 pt-4 pb-3" id="chk-errors" role="tabpanel" aria-labelledby="errors-tab">
        <h5>Errores</h5>
        <span>Total: <span class="val-errors">0</span></span>
        <br />
        <button onclick="document.getElementById('errors').innerHTML = ''; updateCountsDisplay();"><i class="fas fa-trash-alt"></i> Limpiar</button>
        <pre id="errors"></pre>
      </div>
    </div>
  </div>
  </div> <div id="adminPanel">
    <div id="adminSessionInfo" style="background: rgba(220, 38, 38, 0.15); border-color: rgba(220, 38, 38, 0.3);">
      <span>Panel de Administración Activo</span>
      <button id="adminLogoutBtn" style="background: linear-gradient(45deg, #dc2626, #b91c1c);"><i class="fas fa-sign-out-alt"></i> Salir</button>
    </div>

    <div class="admin-container">
      <div class="admin-header">
        <div class="header-container">
          <img src="logo.png" alt="Logo" class="header-logo">
          <div class="header-title">
            <h3 class="admin-title">PANEL DE ADMINISTRACIÓN</h3>
            <p class="admin-subtitle">Gestión de Keys y Sistema</p>
          </div>
        </div>
      </div>

      <div class="admin-stats">
        <div class="stat-card">
          <div class="stat-number" id="totalKeysCount">0</div>
          <div class="stat-label">Total Keys</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="activeKeysCount">0</div>
          <div class="stat-label">Keys Activas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="usedKeysCount">0</div>
          <div class="stat-label">Keys Agotadas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="expiredKeysCount">0</div>
          <div class="stat-label">Keys Expiradas</div>
        </div>
      </div>

      <div class="key-management">
        <h4 style="color: #a5f3fc; margin-bottom: 20px;"><i class="fas fa-key"></i> Agregar Nueva Key</h4>
        
        <div class="form-row">
          <div class="form-group">
            <label for="newKeyCode">Código de Key</label>
            <input type="text" id="newKeyCode" placeholder="Ej: ZHENTIO-G3V9-PQ1X-R2Y5-Z7W8-C6D0-A1B2" maxlength="40">
          </div>
          <div class="form-group">
            <label for="creditsAssigned">Créditos Asignados</label>
            <input type="number" id="creditsAssigned" min="1" max="99999" value="100" placeholder="Ej: 1000">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="keyMaxUses">Máximo de Activaciones (Usos)</label>
            <input type="number" id="keyMaxUses" min="1" max="100000" value="99999" placeholder="1">
          </div>
          <div class="form-group">
            <label for="customDescription">Descripción (Para Admin)</label>
            <input type="text" id="customDescription" placeholder="Ej: Key de prueba 100 créditos">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="keyExpiryDate">Fecha de Expiración (Opcional)</label>
            <input type="date" id="keyExpiryDate">
          </div>
        </div>

        <button class="btn-admin btn-success" onclick="addNewKey()">
          <i class="fas fa-plus"></i> Agregar Key
        </button>
        <button class="btn-admin btn-primary" onclick="generateRandomKey()">
          <i class="fas fa-random"></i> Generar Aleatoria
        </button>
        <button class="btn-admin btn-warning" onclick="exportKeys()">
          <i class="fas fa-download"></i> Exportar Keys
        </button>
        <button class="btn-admin btn-danger" onclick="clearAllKeys()">
          <i class="fas fa-trash"></i> Limpiar Todo
        </button>
      </div>

      <div class="keys-table">
        <h4 style="color: #a5f3fc; margin-bottom: 15px;"><i class="fas fa-list"></i> Keys del Sistema</h4>
        <table id="keysTable">
          <thead>
            <tr>
              <th>Código</th>
              <th>Tipo</th>
              <th>Créditos</th>
              <th>Activaciones</th>
              <th>Estado</th>
              <th>Creada</th>
              <th>Expira</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="keysTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

  <script>
    // index.html (dentro de la etiqueta <script> al final del body)

    // --- CONFIGURACIÓN DE TU BACKEND ---
    // ¡IMPORTANTE! Cuando subas tu backend a un servicio como Railway o Render,
    // DEBERÁS CAMBIAR esta URL por la URL REAL de tu backend desplegado.
    // Por ahora, para pruebas locales, usa http://127.0.0.1:3000/api
    const YOUR_BACKEND_URL = 'http://127.0.0.1:3000/api'; 

    // Algoritmo de hash simple (se mantiene para usos client-side, como checksums locales)
    function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convertir a 32 bits
        }
        return Math.abs(hash).toString(16);
    }

    // Función para obtener timestamp real del servidor (ahora vía backend)
    async function getServerTimestamp() {
      try {
        const response = await fetch(`${YOUR_BACKEND_URL}/timestamp`, {
          method: 'GET',
          cache: 'no-cache'
        });
        const data = await response.json();
        return data.timestamp; // Tu backend devuelve { timestamp: <valor_en_ms> }
      } catch (error) {
        console.warn('No se pudo obtener la hora del servidor del backend, usando hora local. Posiblemente el backend no está corriendo.');
        return Date.now(); // Fallback: usar hora local
      }
    }

    // Variables de autenticación y estado global
    let authenticated = false;
    let userSession = null; // Almacenará los datos de la sesión del usuario (créditos, nivel, etc.)
    let isAdmin = false;

    let tarjetas = [];
    let cookies = "";
    let paused = false;
    let checking = false;

    // Contadores
    let livesCount = 0;
    let diesCount = 0;
    let errorsCount = 0;
    let testedCount = 0;
    let totalCards = 0;

    // Sonido para live
    const audioLive = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');

    // Funciones para mostrar/ocultar pantallas
    function showLoginScreen() {
      $("#loginScreen").addClass("show").show();
      $("#mainApp").hide();
      $("#adminPanel").hide();
      isAdmin = false;
    }

    function showMainApp() {
      $("#loginScreen").removeClass("show").hide();
      $("#mainApp").show();
      $("#adminPanel").hide();
      isAdmin = false;
    }

    function showAdminPanel() {
      $("#loginScreen").removeClass("show").hide();
      $("#mainApp").hide();
      $("#adminPanel").addClass("show").show();
      isAdmin = true;
      loadAdminPanel(); // Carga los datos del panel desde el backend
    }

    // --- FUNCIONES DE AUTENTICACIÓN (hablan con el Backend) ---

    // Función para manejar el login
    async function handleLogin() {
      const keyInput = $("#keyInput").val().trim();
      
      if (!keyInput) {
        toastr.error("Por favor, ingresa una key válida.");
        return;
      }

      $("#loginBtn").prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i> Validando...');

      try {
        const response = await fetch(`${YOUR_BACKEND_URL}/auth/validate-key`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: keyInput })
        });

        const result = await response.json();

        if (!response.ok || !result.isValid) { // Si la respuesta no es OK o isValid es false
            toastr.error(result.message || "Key inválida o error en el servidor.");
            return;
        }

        // Si la key es válida, el backend devuelve un sessionToken y keyData
        localStorage.setItem('sessionToken', result.sessionToken);
        userSession = result.keyData; // El backend nos envía los datos de la key
        authenticated = true;
        
        if (userSession.level === 'admin') {
          toastr.success("¡Acceso de administrador concedido!", "Bienvenido Admin");
          $("#keyInput").val("");
          showAdminPanel();
        } else {
          toastr.success(`¡Acceso concedido! Key de ${userSession.creditsAssigned} créditos.`, "Bienvenido");
          $("#keyInput").val("");
          await updateSessionInfo();
          showMainApp();
        }
        
        startSessionMonitoring(); // Inicia el chequeo periódico de la sesión
        
      } catch (error) {
        console.error('Error durante el login:', error);
        toastr.error("Error al conectar con el servidor de autenticación. Asegúrate de que el backend esté corriendo.");
      } finally {
        $("#loginBtn").prop("disabled", false).html('<i class="fas fa-key"></i> Acceder');
      }
    }

    // Función para verificar si la sesión es válida (con el Backend)
    async function isSessionValid() {
      const sessionToken = localStorage.getItem('sessionToken');
      if (!sessionToken) return false;

      try {
        const response = await fetch(`${YOUR_BACKEND_URL}/auth/verify-session`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionToken}` // Envía el token al backend
            }
        });

        const data = await response.json();

        if (!response.ok || !data.isValid) { // Si el backend dice que el token es inválido o expirado
            toastr.error(data.message || "Sesión inválida o expirada.");
            return false;
        }

        userSession = data.sessionData; // Actualiza los datos de la sesión con los más recientes del backend
        return true;
      } catch (error) {
        console.error('Error de red al verificar sesión:', error);
        // Si hay un error de red, la sesión no puede ser validada
        toastr.error("Error de conexión al verificar la sesión. Intenta de nuevo.");
        return false;
      }
    }

    // Función para cerrar sesión
    function logout() {
      localStorage.removeItem('sessionToken'); // Elimina el token JWT
      authenticated = false;
      userSession = null;
      isAdmin = false;
      stopChecker();
      toastr.info("Sesión cerrada correctamente.");
      showLoginScreen();
    }

    // Función para actualizar información de sesión en la UI
    async function updateSessionInfo() {
      if (!userSession) return;
      
      let sessionText = `<span><i class="fas fa-shield-alt"></i> Sesión activa - `;
      if (userSession.level === 'admin') {
          sessionText += `ADMINISTRADOR`;
      } else {
          sessionText += `${userSession.creditsAssigned} CRÉDITOS`;
      }
      sessionText += `</span> <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>`;
      $("#sessionInfo").html(sessionText);
    }

    // Función para monitoreo continuo de sesión (llama al backend)
    function startSessionMonitoring() {
      // Verifica la sesión cada 30 segundos
      setInterval(async () => {
        if (!authenticated) return; // Detiene el monitoreo si ya no está autenticado
        const isValid = await isSessionValid();
        if (!isValid) {
          toastr.error("⚠️ Sesión expirada o manipulada. Redirigiendo al login...");
          logout();
        }
      }, 30000); // Cada 30 segundos
    }

    // --- FUNCIONES DEL CHECKER (hablan con el Backend) ---

    async function checkNextCard() {
      if (paused || !checking) return;
      if (tarjetas.length === 0) {
        updateStatus("Finalizado.");
        enableControls(true, false, false);
        checking = false;
        return;
      }

      // Pre-validación de créditos en el frontend para no-admins (el backend también validará)
      if (userSession && userSession.level !== 'admin' && userSession.creditsAssigned < 2) { 
          toastr.error("⚠️ No tienes suficientes créditos para continuar el chequeo. Necesitas 2 créditos por LIVE.");
          stopChecker(); 
          return;
      }

      const card = tarjetas[0];
      testedCount++;
      updateStatus(`Chequeando: ${card} (${testedCount}/${totalCards})`);
      updateCountsDisplay();

      try {
        const sessionToken = localStorage.getItem('sessionToken');
        const response = await fetch(`${YOUR_BACKEND_URL}/checker/check-card`, { // Llama al endpoint de tu backend
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionToken}` // Envía el token
            },
            body: JSON.stringify({ card: card, cookie: cookies })
        });

        const result = await response.json(); // Tu backend devuelve { status, message, creditsRemaining, creditsConsumed }

        if (!response.ok) { // Si el backend devolvió un error HTTP (ej. 402, 403, 500)
            toastr.error(result.message || "Error al chequear tarjeta desde el servidor.");
            if (result.message.includes("créditos") || result.message.includes("token")) {
                logout(); // Cierra sesión si hay problemas de créditos o token
            }
            throw new Error(result.message || 'Error en el backend al chequear');
        }

        let estado = "ERROR ⚠️";

        if (result.status === "LIVE") {
          estado = "LIVE ✅";
          $("#lives").append(card + " => " + estado + "\n");
          livesCount++;
          audioLive.play();

          // Actualiza créditos en el userSession y UI con los datos del backend
          if (userSession && userSession.level !== 'admin') {
              userSession.creditsAssigned = result.creditsRemaining;
              await updateSessionInfo();
              toastr.info(`-${result.creditsConsumed} créditos. Créditos restantes: ${userSession.creditsAssigned}`);
          }

        } else if (result.status === "DIE") {
          estado = "DIE ❌";
          $("#dies").append(card + " => " + estado + "\n");
          diesCount++;
        } else { // status === "ERROR"
          $("#errors").append(card + " => " + (result.message || estado) + "\n");
          errorsCount++;
        }
      } catch (error) {
        $("#errors").append(card + " => ERROR de Conexión/API (Cliente) ⚠️\n");
        errorsCount++;
      } finally {
        tarjetas.shift();
        updateCardListDisplay();
        updateCountsDisplay();

        // Detener si los créditos se agotan (para no-admins)
        if (userSession && userSession.level !== 'admin' && userSession.creditsAssigned <= 0 && checking) {
            toastr.error("⚠️ Tus créditos se han agotado. El chequeo se ha detenido.");
            stopChecker();
            return;
        }

        if (checking && !paused) {
          setTimeout(checkNextCard, 100);
        }
      }
    }

    // Funciones de control del Checker (mantienen la lógica local)
    function stopChecker() { 
      checking = false; 
      paused = false; 
      updateStatus("Detenido.");
      enableControls(true, false, false); 
      $("#chk-pause").html('<i class="fas fa-pause"></i> Pausar');
    }
    function enableControls(startEnabled, pauseEnabled, stopEnabled) {
      $("#chk-start").prop("disabled", !startEnabled);
      $("#chk-pause").prop("disabled", !pauseEnabled);
      $("#chk-stop").prop("disabled", !stopEnabled);
    }
    function resetContadores() {
      livesCount = 0; diesCount = 0; errorsCount = 0; testedCount = 0; totalCards = 0; 
      $("#lives, #dies, #errors").empty(); 
      updateCountsDisplay();
    }
    function updateStatus(text) { $("#estatus").text(text); }
    function cleanResponseText(rawHtml) {
        let cleanText = rawHtml.replace(/<.*?>/g, '').trim().toLowerCase();
        const traducciones = {
            "conta sem endereço ou suspensa": "cuenta sin direccion o suspendida",
            "reprovada": "rechazada",
            "aprovada": "aprobada",
            "recusado": "rechazada",
            "cartão autorizado": "tarjeta autorizada",
            "autorizado": "aprobada"
        };
        for (const original in traducciones) { cleanText = cleanText.replace(original, traducciones[original]); }
        return cleanText;
    }
    function updateCardListDisplay() { $("#lista_cartoes").val(tarjetas.join("\n")); }

    // Eventos Click para botones del Checker
    $("#chk-start").click(() => {
      if (!authenticated) { toastr.error("Sesión no válida. Inicia sesión nuevamente."); showLoginScreen(); return; }
      if (userSession && userSession.level !== 'admin' && userSession.creditsAssigned < 2) { toastr.error("⚠️ No tienes suficientes créditos para iniciar el chequeo. Necesitas al menos 2 créditos."); return; }
      if (checking) return;
      cookies = $("#cookie_input").val().trim();
      tarjetas = $("#lista_cartoes").val().trim().split("\n").filter(l => l.trim() !== "");
      if (!cookies) { toastr.error("Por favor, ingresa las cookies primero."); return; }
      if (tarjetas.length === 0) { toastr.warning("No se ingresaron tarjetas."); return; }
      resetContadores(); 
      totalCards = tarjetas.length; 
      updateCountsDisplay(); 
      checking = true; 
      paused = false; 
      updateStatus("Chequeando...");
      enableControls(false, true, true); 
      checkNextCard();
    });
    $("#chk-pause").click(() => {
      if (!checking) return;
      paused = !paused;
      $("#chk-pause").html(paused ? '<i class="fas fa-play"></i> Reanudar' : '<i class="fas fa-pause"></i> Pausar');
      updateStatus(paused ? "Pausado." : `Chequeando: ${tarjetas[0] || 'N/A'} (${testedCount}/${totalCards})`);
      if (!paused) { checkNextCard(); }
    });
    $("#chk-stop").click(() => { stopChecker(); });
    $("#chk-clean").click(() => {
      stopChecker(); 
      resetContadores(); 
      $("#cookie_input").val(""); 
      $("#lista_cartoes").val(""); 
      updateStatus("Esperando inicio...");
    });
    $("#copyButton").click(() => {
      const text = $("#lives").text().trim();
      if (!text) { toastr.warning("Nada para copiar."); return; }
      navigator.clipboard.writeText(text).then(() => { toastr.success("Aprobadas copiadas al portapapeles."); }).catch(() => { toastr.error("Error al copiar."); });
    });


    // --- FUNCIONES DEL PANEL DE ADMINISTRACIÓN (hablan con el Backend) ---

    // Carga inicial y actualización del panel (obtiene datos del Backend)
    async function loadAdminPanel() {
      await updateKeysTable();
      await updateAdminStats();
    }

    // Añadir nueva Key al Backend
    async function addNewKey() {
        const keyCode = $("#newKeyCode").val().trim().toUpperCase();
        const creditsAssigned = parseInt($("#creditsAssigned").val()); 
        const maxUses = parseInt($("#keyMaxUses").val()) || 99999; 
        const expiryDateInput = $("#keyExpiryDate").val(); 
        let expiryDate = null;
        if (expiryDateInput) expiryDate = new Date(expiryDateInput).getTime();

        if (!keyCode || isNaN(creditsAssigned) || creditsAssigned < 1) {
            toastr.error("Por favor, completa todos los campos requeridos y asegúrate que los créditos sean válidos.");
            return;
        }
        const keyRegex = /^ZHENTIO-([A-Z0-9]{4}-){5}[A-Z0-9]{4}$/; 
        if (!keyRegex.test(keyCode)) {
            toastr.error("El formato de la key no es válido. Usa el generador de keys aleatorias.");
            return;
        }
        const parts = keyCode.split('-');
        const submittedChecksum = parts[6]; 
        const keyWithoutChecksum = parts.slice(0, 6).join('-'); 
        const expectedChecksum = simpleHash(keyWithoutChecksum).substring(0, 4).toUpperCase();
        if (submittedChecksum !== expectedChecksum) {
            toastr.error("Key inválida: Checksum no coincide. Key manipulada o generada incorrectamente.");
            return;
        }

        try {
            const sessionToken = localStorage.getItem('sessionToken');
            const response = await fetch(`${YOUR_BACKEND_URL}/admin/keys/add`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}` 
                },
                body: JSON.stringify({
                    code: keyCode,
                    creditsAssigned: creditsAssigned,
                    maxUses: maxUses,
                    expiryDate: expiryDate,
                    description: $("#customDescription").val().trim() || `${creditsAssigned} créditos`
                })
            });

            const data = await response.json();
            if (!response.ok) {
                toastr.error(data.message || "Error al agregar key en el servidor.");
                return;
            }
            toastr.success(data.message || `Key "${keyCode}" agregada exitosamente.`);
            
            $("#newKeyCode").val("");
            $("#creditsAssigned").val("100"); 
            $("#customDescription").val("");
            $("#keyMaxUses").val("99999"); 
            $("#keyExpiryDate").val("");
            await updateKeysTable();
            await updateAdminStats();

        } catch (error) {
            console.error('Error de red al agregar key:', error);
            toastr.error("No se pudo conectar con el servidor para agregar la key. Asegúrate de que el backend esté corriendo.");
        }
    }

    // Generar Key Aleatoria (solo crea el formato, la clave se valida en el backend)
    function generateRandomKey() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const generateBlock = (length) => {
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };
        const block1 = generateBlock(4); const block2 = generateBlock(4); const block3 = generateBlock(4); 
        const block4 = generateBlock(4); const block5 = generateBlock(4); 
        const partialKey = `ZHENTIO-${block1}-${block2}-${block3}-${block4}-${block5}`; 
        const checksum = simpleHash(partialKey).substring(0, 4).toUpperCase(); 
        $("#newKeyCode").val(`${partialKey}-${checksum}`); 
    }

    // Actualizar tabla de Keys desde el Backend
    async function updateKeysTable() {
        try {
            const sessionToken = localStorage.getItem('sessionToken');
            const response = await fetch(`${YOUR_BACKEND_URL}/admin/keys`, {
                headers: { 'Authorization': `Bearer ${sessionToken}` }
            });

            const keys = await response.json(); 
            if (!response.ok) {
                toastr.error(keys.message || "Error al cargar keys desde el servidor.");
                return;
            }

            const tbody = $("#keysTableBody");
            tbody.empty();
            
            const fixedAdminKeys = [
                { code: 'ADMIN2025', description: 'Admin Fija', type: 'Admin', level: 'admin', creditsAssigned: 999999, maxUses: 999999, currentUses: 0, createdAt: 0, expiryDate: null, lastUsed: null, status: 'active', isCustom: false },
                { code: 'SUPERADMIN', description: 'Super Admin Fija', type: 'Admin', level: 'admin', creditsAssigned: 999999, maxUses: 999999, currentUses: 0, createdAt: 0, expiryDate: null, lastUsed: null, status: 'active', isCustom: false }
            ];
            
            fixedAdminKeys.forEach(key => {
                const statusClass = 'status-active'; 
                const levelBadge = '👑';
                tbody.append(`
                  <tr style="animation: fadeInUp 0.3s ease-out;">
                    <td><strong>${key.code}</strong></td>
                    <td>${levelBadge} ${key.description}</td>
                    <td>${key.creditsAssigned === 999999 ? '∞' : key.creditsAssigned}</td>
                    <td><span style="color: #10b981;">∞</span></td>
                    <td><span class="key-status ${statusClass}">Sistema</span></td>
                    <td><i class="fas fa-cog"></i> Sistema</td>
                    <td>N/A</td>
                    <td><em style="color: #67e8f9;"><i class="fas fa-shield-alt"></i> Protegida</em></td>
                  </tr>
                `);
            });

            keys.forEach(key => {
                const now = Date.now();
                const isExpired = key.expiryDate && key.expiryDate < now;
                const isMaxUsed = key.currentUses >= key.maxUses;
                const outOfCredits = key.creditsAssigned <= 0;
                
                let status = 'active';
                let statusClass = 'status-active';
                
                if (isExpired) { status = 'expirada'; statusClass = 'status-expired'; }
                else if (outOfCredits) { status = 'sin créditos'; statusClass = 'status-inactive'; }
                else if (isMaxUsed) { status = 'agotada'; statusClass = 'status-inactive'; }
                
                const createdDate = new Date(key.createdAt).toLocaleDateString();
                const expiryDate = key.expiryDate ? new Date(key.expiryDate).toLocaleDateString() : 'N/A';
                
                let levelIcon;
                switch(key.level) {
                    case 'admin': levelIcon = '👑'; break;
                    case 'vip': levelIcon = '💎'; break;
                    case 'oro': levelIcon = '🏆'; break; 
                    case 'plata': levelIcon = '🥈'; break; 
                    case 'bronce': levelIcon = '🥉'; break; 
                    case 'basico': levelIcon = '🔰'; break;
                    default: levelIcon = '🔧'; 
                }
                
                tbody.append(`
                  <tr style="animation: slideInLeft 0.4s ease-out;">
                    <td><strong>${key.code}</strong></td>
                    <td>${levelIcon} ${key.description}</td>
                    <td>${key.creditsAssigned}</td>
                    <td>
                      <span style="color: ${isMaxUsed ? '#ef4444' : '#10b981'};">
                        ${key.currentUses}
                      </span>
                      <span style="color: #67e8f9;">/${key.maxUses === 99999 ? '∞' : key.maxUses}</span>
                    </td>
                    <td><span class="key-status ${statusClass}">${status}</span></td>
                    <td><i class="fas fa-calendar"></i> ${createdDate}</td>
                    <td>${expiryDate}</td>
                    <td>
                      <button class="btn-admin btn-small btn-warning" onclick="editKey('${key.code}')" title="Editar">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn-admin btn-small btn-danger" onclick="deleteKey('${key.code}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                      </button>
                      <button class="btn-admin btn-small btn-primary" onclick="resetKeyUses('${key.code}')" title="Resetear activaciones">
                        <i class="fas fa-redo"></i>
                      </button>
                    </td>
                  </tr>
                `);
            });

        } catch (error) {
            console.error('Error al cargar tabla de keys:', error);
            toastr.error("Error al cargar keys. Asegúrate de que el backend esté corriendo.");
        }
    }

    // Actualizar estadísticas del panel desde el Backend
    async function updateAdminStats() {
        try {
            const sessionToken = localStorage.getItem('sessionToken');
            const response = await fetch(`${YOUR_BACKEND_URL}/admin/stats`, {
                headers: { 'Authorization': `Bearer ${sessionToken}` }
            });
            const stats = await response.json(); 

            if (!response.ok) {
                toastr.error(stats.message || "Error al cargar estadísticas desde el servidor.");
                return;
            }

            $("#totalKeysCount").text(stats.totalKeys);
            $("#activeKeysCount").text(stats.activeKeys);
            $("#usedKeysCount").text(stats.usedKeys); 
            $("#expiredKeysCount").text(stats.expiredKeys);

        } catch (error) {
            console.error('Error al cargar estadísticas del panel:', error);
            toastr.error("Error al cargar estadísticas. Asegúrate de que el backend esté corriendo.");
        }
    }

    // Eliminar Key en el Backend
    async function deleteKey(keyCode) {
        if (['ADMIN2025', 'SUPERADMIN'].includes(keyCode)) {
            toastr.error("No puedes eliminar una key de sistema.");
            return;
        }
        if (confirm(`¿Estás seguro de eliminar la key "${keyCode}"?`)) {
            try {
                const sessionToken = localStorage.getItem('sessionToken');
                const response = await fetch(`${YOUR_BACKEND_URL}/admin/keys/${keyCode}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });
                const data = await response.json();
                if (!response.ok) {
                    toastr.error(data.message || "Error al eliminar key en el servidor.");
                    return;
                }
                toastr.success(`Key "${keyCode}" eliminada exitosamente.`);
                await updateKeysTable();
                await updateAdminStats();
            } catch (error) {
                console.error('Error de red al eliminar key:', error);
                toastr.error("No se pudo conectar con el servidor para eliminar la key.");
            }
        }
    }

    // Resetear Usos (Activaciones) de Key en el Backend
    async function resetKeyUses(keyCode) {
        if (['ADMIN2025', 'SUPERADMIN'].includes(keyCode)) {
            toastr.error("No puedes resetear una key de sistema.");
            return;
        }
        if (confirm(`¿Resetear las activaciones de la key "${keyCode}" a 0?`)) {
            try {
                const sessionToken = localStorage.getItem('sessionToken');
                const response = await fetch(`${YOUR_BACKEND_URL}/admin/keys/${keyCode}/reset-uses`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });
                const data = await response.json();
                if (!response.ok) {
                    toastr.error(data.message || "Error al resetear usos en el servidor.");
                    return;
                }
                toastr.success(`Activaciones de "${keyCode}" reseteadas.`);
                await updateKeysTable();
                await updateAdminStats();
            } catch (error) {
                console.error('Error de red al resetear usos:', error);
                toastr.error("No se pudo conectar con el servidor para resetear la key.");
            }
        }
    }

    // Editar Key en el Backend
    async function editKey(keyCode) {
        if (['ADMIN2025', 'SUPERADMIN'].includes(keyCode)) {
            toastr.error("No puedes editar una key de sistema.");
            return;
        }
        try {
            const sessionToken = localStorage.getItem('sessionToken');
            const fetchResponse = await fetch(`${YOUR_BACKEND_URL}/admin/keys/${keyCode}`, {
                headers: { 'Authorization': `Bearer ${sessionToken}` }
            });
            const keyToEdit = await fetchResponse.json();
            if (!fetchResponse.ok) {
                toastr.error(keyToEdit.message || "Error al obtener datos de la key para editar.");
                return;
            }

            const newCredits = prompt(`Nuevo valor de créditos para "${keyCode}" (actual: ${keyToEdit.creditsAssigned}):`, keyToEdit.creditsAssigned);
            if (newCredits === null || isNaN(newCredits) || parseInt(newCredits) < 0) {
                toastr.info("Créditos no modificados o valor inválido.");
                return;
            }
            const parsedNewCredits = parseInt(newCredits);

            const newMaxUses = prompt(`Nuevo máximo de activaciones para "${keyCode}" (actual: ${keyToEdit.maxUses === 99999 ? '∞' : keyToEdit.maxUses}):`, keyToEdit.maxUses);
            if (newMaxUses === null || isNaN(newMaxUses) || parseInt(newMaxUses) <= 0) {
                toastr.info("Máximo de activaciones no modificado o inválido.");
                return;
            }
            const parsedNewMaxUses = parseInt(newMaxUses);

            const updateResponse = await fetch(`${YOUR_BACKEND_URL}/admin/keys/${keyCode}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionToken}` },
                body: JSON.stringify({
                    creditsAssigned: parsedNewCredits,
                    maxUses: parsedNewMaxUses,
                })
            });
            const updateData = await updateResponse.json();
            if (!updateResponse.ok) {
                toastr.error(updateData.message || "Error al actualizar key en el servidor.");
                return;
            }
            toastr.success(`Key "${keyCode}" actualizada exitosamente.`);
            await updateKeysTable();
            await updateAdminStats();

        } catch (error) {
            console.error('Error de red al editar key:', error);
            toastr.error("No se pudo conectar con el servidor para editar la key.");
        }
    }

    // Exportar Keys desde el Backend
    async function exportKeys() {
        try {
            const sessionToken = localStorage.getItem('sessionToken');
            const response = await fetch(`${YOUR_BACKEND_URL}/admin/keys/export`, {
                headers: { 'Authorization': `Bearer ${sessionToken}` }
            });
            if (!response.ok) {
                const errorData = await response.json();
                toastr.error(errorData.message || "Error al exportar keys desde el servidor.");
                return;
            }
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `keys_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            toastr.success("Keys exportadas exitosamente.");

        } catch (error) {
            console.error('Error de red al exportar keys:', error);
            toastr.error("No se pudo conectar con el servidor para exportar las keys.");
        }
    }

    // Limpiar todas las Keys Personalizadas en el Backend
    async function clearAllKeys() {
        if (confirm("⚠️ ¿Estás seguro de eliminar TODAS las keys personalizadas? Esta acción no se puede deshacer.")) {
            if (confirm("⚠️ CONFIRMACIÓN FINAL: Esto eliminará todas las keys personalizadas permanentemente.")) {
                try {
                    const sessionToken = localStorage.getItem('sessionToken');
                    const response = await fetch(`${YOUR_BACKEND_URL}/admin/keys/clear-all`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${sessionToken}` }
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        toastr.error(data.message || "Error al limpiar keys en el servidor.");
                        return;
                    }
                    toastr.warning("Todas las keys personalizadas han sido eliminadas.");
                    await updateKeysTable();
                    await updateAdminStats();
                } catch (error) {
                    console.error('Error de red al limpiar todas las keys:', error);
                    toastr.error("No se pudo conectar con el servidor para limpiar las keys.");
                }
            }
        }
    }

    // --- Inicialización de la Aplicación ---

    $(document).ready(async () => {
      enableControls(true, false, false); 
      updateStatus("Esperando inicio...");
      updateCountsDisplay();
      
      await checkSession();
      
      $("#loginBtn").click(handleLogin);
      $(document).on('click', '#logoutBtn', logout);
      $(document).on('click', '#adminLogoutBtn', logout);
      
      $("#keyInput").keypress((e) => {
        if (e.which === 13) { 
          handleLogin();
        }
      });
    });
